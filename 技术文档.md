# æŠ€æœ¯æ–‡æ¡£

**æœ€åæ›´æ–°**ï¼š2025-12-14  
**é¡¹ç›®**ï¼šåŸºäºä¸ç¡®å®šæ€§å»ºæ¨¡çš„EMGèåˆæœºåˆ¶

---

## ğŸ“‹ ç›®å½•ç»“æ„

```
project/
â”œâ”€â”€ data/                  # æ•°æ®ç›®å½•
â”œâ”€â”€ scripts/               # æ‰€æœ‰è„šæœ¬
â”œâ”€â”€ tests/                 # å•å…ƒæµ‹è¯•
â”œâ”€â”€ configs/               # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ lexicons/          # è¯è¡¨ï¼ˆDay6ç”Ÿæˆï¼‰
â”œâ”€â”€ output/                # è¾“å‡ºç›®å½•
â”œâ”€â”€ checkpoints/           # æ¨¡å‹checkpoint
â””â”€â”€ requirements.txt
```

---

## Day1: æ•°æ®å‡†å¤‡

### ä»»åŠ¡ç›®æ ‡
æ„å»ºå®Œæ•´æ•°æ®é›†ï¼šæ•°æ®æ¸…æ´—ã€æ ‡ç­¾æ ‡æ³¨ã€æ•°æ®é›†åˆ’åˆ†ã€‚

### æ ¸å¿ƒè„šæœ¬
- `txt_to_jsonl.py`: TXTè½¬JSONL
- `data_cleaner.py`: æ•°æ®æ¸…æ´—
- `coarse_label.py`: ä¸»æ ‡ç­¾æ ‡æ³¨ï¼ˆæ•æ„Ÿ/éæ•æ„Ÿï¼‰
- `subtype_assign.py`: å­æ ‡ç­¾æ ‡æ³¨ï¼ˆporn/politics/abuse/otherï¼‰
- `dataset_split.py`: æ•°æ®é›†åˆ’åˆ†ï¼ˆtrain/dev/testï¼‰
- `hardset_maker.py`: å›°éš¾é›†æ„å»º

### è¾“å…¥è¾“å‡º

**è¾“å…¥**ï¼š`data/unprocessed/*.txt`

**è¾“å‡º**ï¼š
- `data/train.jsonl`: 39,583 æ¡
- `data/dev.jsonl`: 4,948 æ¡
- `data/test.jsonl`: 4,948 æ¡
- `data/hard_eval_set.jsonl`: å›°éš¾æ ·æœ¬é›†

### å…³é”®é…ç½®
- **LLMæ¨¡å‹**: `gemma-3-27b-it`ï¼ˆæ‰¹é‡å¤„ç†ï¼Œ30 RPMé™åˆ¶ï¼‰
- **æ•°æ®åˆ’åˆ†**: 8:1:1 (stratify by coarse label)

---

## Day2: Baseline è®­ç»ƒ

### ä»»åŠ¡ç›®æ ‡
è®­ç»ƒäºŒåˆ†ç±»åŸºçº¿æ¨¡å‹ï¼ˆæ•æ„Ÿ/éæ•æ„Ÿï¼‰ã€‚

### æ ¸å¿ƒè„šæœ¬
- `baseline_train.py`: Baselineæ¨¡å‹è®­ç»ƒ

### å…³é”®å‚æ•°
- **æ¨¡å‹**: Qwen-1.7B + LoRAå¾®è°ƒ
- **ä»»åŠ¡**: äºŒåˆ†ç±»ï¼ˆcoarse labelï¼‰
- **è®­ç»ƒ**: 3 epochs

### å®éªŒç»“æœ
- **éªŒè¯é›† F1**: 88.3%
- **éªŒè¯é›† Accuracy**: 84.6%
- **éªŒè¯é›† Precision**: 87.1%
- **éªŒè¯é›† Recall**: 89.6%

### è¾“å‡º
- `checkpoints/baseline-lora/`: LoRAé€‚é…å™¨checkpoint

---

## Day3: Baseline è¯„ä¼°

### ä»»åŠ¡ç›®æ ‡
åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°Baselineæ¨¡å‹æ€§èƒ½ã€‚

### æ ¸å¿ƒè„šæœ¬
- `eval_baseline.py`: Baselineè¯„ä¼°

### å®éªŒç»“æœ
- **æµ‹è¯•é›† F1**: 89.13%
- **æµ‹è¯•é›† Accuracy**: 85.95%
- **æµ‹è¯•é›† Precision**: 89.42%
- **æµ‹è¯•é›† Recall**: 88.83%
- **é«˜ç½®ä¿¡é”™è¯¯æ ·æœ¬**: 444 ä¸ªï¼ˆç½®ä¿¡åº¦ â‰¥ 0.8ï¼‰

---

## Day4: ä¸ç¡®å®šæ€§åˆ†æ

### ä»»åŠ¡ç›®æ ‡
åˆ†ææ¨¡å‹ä¸ç¡®å®šæ€§ u ä¸é”™è¯¯ç‡çš„ç›¸å…³æ€§ã€‚

### æ ¸å¿ƒè„šæœ¬
- `uncertainty_analysis.py`: ä¸ç¡®å®šæ€§åˆ†æ

### ä¸ç¡®å®šæ€§å®šä¹‰
```
u = 1 - max_c pÎ¸(c|x)
```
å…¶ä¸­ `pÎ¸(c|x)` æ˜¯æ¨¡å‹é¢„æµ‹æ¦‚ç‡ã€‚

### å®éªŒç»“æœ
- **ç›¸å…³ç³»æ•°**: 0.8379ï¼ˆå¼ºæ­£ç›¸å…³ï¼‰
- **åˆ†æ¡¶ç»Ÿè®¡**:
  - ä½uï¼ˆu < 0.1ï¼‰: 79.1% æ ·æœ¬ï¼Œé”™è¯¯ç‡ 8.56%
  - ä¸­uï¼ˆ0.1 â‰¤ u < 0.3ï¼‰: 13.0% æ ·æœ¬ï¼Œé”™è¯¯ç‡ 33.64%
  - é«˜uï¼ˆu â‰¥ 0.3ï¼‰: 7.9% æ ·æœ¬ï¼Œé”™è¯¯ç‡ 33-100%

### è¾“å‡º
- `output/dev_with_uncertainty.jsonl`: devé›†+ä¸ç¡®å®šæ€§
- `output/test_with_uncertainty.jsonl`: testé›†+ä¸ç¡®å®šæ€§
- `output/uncertainty_buckets.csv`: åˆ†æ¡¶ç»Ÿè®¡

---

## Day5: æ ¡å‡†åˆ†æ

### ä»»åŠ¡ç›®æ ‡
åˆ†æBaselineæ¨¡å‹çš„æ ¡å‡†è¯¯å·®ï¼ˆECE/MCEï¼‰ã€‚

### æ ¸å¿ƒè„šæœ¬
- `calibration_analysis.py`: æ ¡å‡†åˆ†æ

### çŠ¶æ€
âš ï¸ è„šæœ¬å·²å®Œæˆï¼Œå¾…è¿è¡Œï¼ˆå¯é€‰ä»»åŠ¡ï¼‰

---

## Day6: çŸ¥è¯†åéªŒæ„å»º

### ä»»åŠ¡ç›®æ ‡
æ„å»ºè§„åˆ™çŸ¥è¯†åéªŒ qâ‚€(c|z)ã€‚

### æ ¸å¿ƒè„šæœ¬
- `lexicon_generator.py`: è¯è¡¨ç”Ÿæˆï¼ˆä½¿ç”¨LLMï¼‰
- `q0_builder.py`: qâ‚€åéªŒæ„å»º

### è¯è¡¨ç”Ÿæˆ
- **porn**: 7,390 ä¸ªè¯
- **politics**: 17,337 ä¸ªè¯
- **abuse**: 11,283 ä¸ªè¯
- **æ€»è®¡**: 36,010 ä¸ªè¯

### qâ‚€è®¡ç®—é€»è¾‘
1. è¯è¡¨åŒ¹é…ï¼ˆä½¿ç”¨pyahocorasickè‡ªåŠ¨æœºåŠ é€Ÿï¼‰
2. åŒ¹é…åˆ†æ•°è®¡ç®—ï¼š`match_score = Î£(weight Ã— count)`
3. æ¦‚ç‡æ˜ å°„ï¼š`p_sensitive = base + (max - base) Ã— tanh(match_score Ã— scale)`

### å…³é”®å‚æ•°ï¼ˆä¼˜åŒ–åï¼‰
- `base_sensitive_prob`: 0.1
- `max_sensitive_prob`: 0.75ï¼ˆä»0.95é™ä½ï¼‰
- `min_matches_for_sensitive`: 2ï¼ˆä»1æé«˜ï¼‰
- `politics_weight`: 0.6ï¼ˆä»0.8é™ä½ï¼‰
- `abuse_weight`: 0.5ï¼ˆä»0.6é™ä½ï¼‰
- `tanhç¼©æ”¾å› å­`: 5ï¼ˆä»10é™ä½ï¼‰

### è¾“å‡º
- `data/q0_train.jsonl`: trainé›†qâ‚€
- `data/q0_dev.jsonl`: devé›†qâ‚€
- `data/q0_test.jsonl`: testé›†qâ‚€

---

## Day7: EMG Î± æœç´¢

### ä»»åŠ¡ç›®æ ‡
ä¸ºæ¯ä¸ªä¸ç¡®å®šæ€§bucketæœç´¢æœ€ä¼˜èåˆæƒé‡ Î±*ã€‚

### æ ¸å¿ƒè„šæœ¬
- `emg_bucket_search.py`: åˆ†æ¡¶Î±æœç´¢

### EMGèåˆå…¬å¼
```
p_emg(c|x) = Î± Ã— p(c|x) + (1 - Î±) Ã— qâ‚€(c|z)
```
- `p(c|x)`: baselineæ¨¡å‹é¢„æµ‹æ¦‚ç‡
- `qâ‚€(c|z)`: çŸ¥è¯†åéªŒ
- `Î±`: èåˆæƒé‡ï¼ˆÎ±è¶Šå¤§è¶Šä¿¡ä»»æ¨¡å‹ï¼‰

### æœç´¢ç­–ç•¥
- å¯¹æ¯ä¸ªu bucketï¼Œæšä¸¾ Î± âˆˆ {0, 0.25, 0.5, 0.75, 1}
- è®¡ç®—F1å’ŒNLL
- é€‰æ‹©ä½¿F1æœ€å¤§çš„Î±*

### å®éªŒç»“æœ

| Bucket | u_mean | n_samples | alpha_star | è¯´æ˜ |
|--------|--------|-----------|------------|------|
| 0 | 0.016 | 3,912 | 0.75 | ä½uï¼Œä¿¡ä»»æ¨¡å‹ |
| 1 | 0.146 | 368 | 0.25 | ä¸­ç­‰uï¼Œå¹³è¡¡ |
| 2 | 0.248 | 284 | 0.50 | ä¸­ç­‰uï¼Œå¹³è¡¡ |
| 3 | 0.349 | 207 | 0.00 | é«˜uï¼Œä¿¡ä»»çŸ¥è¯† |
| 4 | 0.451 | 177 | 0.00 | é«˜uï¼Œä¿¡ä»»çŸ¥è¯† |

**ç»“è®º**ï¼šâœ… Î±*ç¬¦åˆç†è®ºé¢„æœŸï¼ˆä½uæ—¶Î±å¤§ï¼Œé«˜uæ—¶Î±å°ï¼‰

### è¾“å‡º
- `output/bucket_alpha_star.csv`: æ¯ä¸ªbucketçš„æœ€ä¼˜Î±*

---

## Day8: PAV æ‹Ÿåˆ

### ä»»åŠ¡ç›®æ ‡
ä½¿ç”¨PAVä¿åºå›å½’æ‹Ÿåˆå•è°ƒé€’å‡çš„Î±(u)å‡½æ•°ã€‚

### æ ¸å¿ƒè„šæœ¬
- `emg_fit_alpha_u.py`: PAVæ‹Ÿåˆ

### PAVç®—æ³•
- **ç›®æ ‡**: ä»ç¦»æ•£çš„(u, Î±*)ç‚¹æ‹Ÿåˆå•è°ƒé€’å‡å‡½æ•°
- **æ–¹æ³•**: Pool Adjacent Violatorsç®—æ³•
- **çº¦æŸ**: Î±(u) å•è°ƒé€’å‡ï¼ˆuå¢å¤§ï¼ŒÎ±å‡å°ï¼‰

### å®éªŒç»“æœ
- **æŸ¥è¡¨ç‚¹æ•°**: 100ä¸ª
- **uèŒƒå›´**: [0.0156, 0.4510]
- **Î±èŒƒå›´**: [0.0000, 0.7500]
- **å•è°ƒæ€§éªŒè¯**: âœ… é€šè¿‡

### è¾“å‡º
- `output/alpha_u_lut.json`: Î±(u)æŸ¥è¡¨ï¼ˆ100ä¸ªç‚¹ï¼‰
- `output/alpha_u_curve.png`: å¯è§†åŒ–æ›²çº¿

---

## Day9: EMG æ•ˆæœéªŒè¯ä¸é—¨æ§ä¼˜åŒ–

### ä»»åŠ¡ç›®æ ‡
1. è¯„ä¼°EMGèåˆåœ¨æµ‹è¯•é›†ä¸Šçš„æ•ˆæœ
2. å®æ–½é—¨æ§æœºåˆ¶ä¼˜åŒ–ï¼ˆçŸ¥è¯†é˜ˆå€¼é—¨æ§ã€ä¸€è‡´æ€§é—¨æ§ï¼‰

### æ ¸å¿ƒè„šæœ¬
- `eval_emg.py`: EMGæ•ˆæœè¯„ä¼°

### è¯„ä¼°æ–¹æ³•
1. **Baseline**: ä»…ä½¿ç”¨æ¨¡å‹é¢„æµ‹
2. **Fixed Alpha**: å›ºå®šÎ±èåˆï¼ˆÎ±=0.5ï¼‰
3. **EMG**: ä½¿ç”¨Î±(u)å‡½æ•°åŠ¨æ€èåˆ

### è¯„ä¼°æŒ‡æ ‡
- **F1**: åˆ†ç±»å‡†ç¡®ç‡
- **NLL**: è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼ˆæ¦‚ç‡è´¨é‡ï¼‰
- **ECE**: é¢„æœŸæ ¡å‡†è¯¯å·®ï¼ˆæ ¡å‡†è´¨é‡ï¼‰

### å®éªŒç»“æœ

**å…¨å±€å¯¹æ¯”**ï¼š
| æ–¹æ³• | F1 | NLL | ECE |
|------|----|-----|-----|
| Baseline | 89.13% | 0.4001 | 0.0730 |
| EMG | 88.13% | 0.3892 | 0.0648 |
| **æ”¹è¿›** | -1.11% | **-2.72%** âœ… | **-11.16%** âœ… |

**ä¸ç¡®å®šæ€§åˆ‡ç‰‡è¯„ä¼°**ï¼š
| åˆ‡ç‰‡ | æ ·æœ¬å æ¯” | F1å˜åŒ– | NLLå˜åŒ– | ECEå˜åŒ– |
|------|---------|--------|---------|---------|
| ä½uï¼ˆu < 0.1ï¼‰ | 79% | 0% âœ… | -11.8% âœ… | +7.7% âš ï¸ |
| ä¸­ç­‰uï¼ˆ0.1â‰¤u<0.3ï¼‰ | 13% | -9.41% âŒ | +0.6% âŒ | -4.7% âœ… |
| é«˜uï¼ˆu â‰¥ 0.3ï¼‰ | 8% | +1.14% âœ… | +34.6% âŒ | +430.89% âŒ |

### è¾“å‡º
- `output/emg_comparison_table.csv`: æ–¹æ³•å¯¹æ¯”è¡¨
- `output/emg_comparison_charts.png`: å¯è§†åŒ–å›¾è¡¨

### Day9 æ”¹è¿›ï¼šé—¨æ§æœºåˆ¶ä¼˜åŒ–

#### çŸ¥è¯†é˜ˆå€¼é—¨æ§
- **ç›®æ ‡**ï¼šé¿å…ä½¿ç”¨å¼±çŸ¥è¯†ï¼ˆqâ‚€ç½®ä¿¡åº¦ä½æ—¶ï¼‰
- **æ–¹æ³•**ï¼šåœ¨éªŒè¯é›†ä¸Šæœç´¢æœ€ä¼˜é˜ˆå€¼ï¼ˆè€Œéç¡¬ç¼–ç ï¼‰
- **è§„åˆ™**ï¼šå½“ `max(qâ‚€) < learned_threshold` æ—¶ï¼Œè®¾ç½® Î±=1.0
- **è„šæœ¬**ï¼š`scripts/search_knowledge_threshold.py`

#### ä¸€è‡´æ€§é—¨æ§
- **ç›®æ ‡**ï¼šé¿å…qâ‚€ä¸æ¨¡å‹é¢„æµ‹å†²çªæ—¶å¼•å…¥å™ªå£°
- **è§„åˆ™**ï¼šä»…å½“ `argmax(p) == argmax(qâ‚€)` æ—¶å…è®¸Î±(u)ç”Ÿæ•ˆ
- **å®ç°**ï¼šåœ¨ `eval_emg.py` ä¸­æ·»åŠ ä¸€è‡´æ€§æ£€æŸ¥

---

## ğŸ”§ å…³é”®é…ç½®å‚æ•°

### qâ‚€æ„å»ºå‚æ•°ï¼ˆconfigs/config.yamlï¼‰

```yaml
q0:
  base_sensitive_prob: 0.1
  max_sensitive_prob: 0.75      # ä»0.95é™ä½
  min_matches_for_sensitive: 2  # ä»1æé«˜
  politics_weight: 0.6          # ä»0.8é™ä½
  abuse_weight: 0.5             # ä»0.6é™ä½
```

### æ¨¡å‹é…ç½®

```yaml
model:
  name_or_path: /mnt/workspace/models/qwen/Qwen3-1___7B
  use_lora: true
  lora_r: 8
  lora_alpha: 16
```

---

## ğŸ“ æ•°æ®æ ¼å¼

### JSONLæ ‡å‡†æ ¼å¼

```json
{
  "id": "s1234",
  "text": "æ–‡æœ¬å†…å®¹",
  "coarse_label": 1,
  "subtypes": ["porn"],
  "pred_probs": [0.2, 0.8],
  "uncertainty": 0.15,
  "q0": [0.1, 0.9]
}
```

---

## ğŸš€ è¿è¡Œæµç¨‹

### å®Œæ•´å®éªŒæµç¨‹

```bash
# Day1: æ•°æ®å‡†å¤‡
python scripts/txt_to_jsonl.py
python scripts/data_cleaner.py
python scripts/coarse_label.py
python scripts/subtype_assign.py
python scripts/dataset_split.py

# Day2: è®­ç»ƒBaseline
python scripts/baseline_train.py

# Day3: è¯„ä¼°Baseline
python scripts/eval_baseline.py

# Day4: ä¸ç¡®å®šæ€§åˆ†æ
python scripts/uncertainty_analysis.py --dev-file dev.jsonl

# Day6: æ„å»ºqâ‚€
python scripts/lexicon_generator.py
python scripts/q0_builder.py --datasets train dev test

# Day7: æœç´¢Î±*
python scripts/emg_bucket_search.py

# Day8: æ‹ŸåˆÎ±(u)
python scripts/emg_fit_alpha_u.py

# Day9: è¯„ä¼°EMG
python scripts/eval_emg.py

# Day9 æ”¹è¿›ï¼šæœç´¢çŸ¥è¯†é˜ˆå€¼
python scripts/search_knowledge_threshold.py

# Day9 æ”¹è¿›ï¼šä½¿ç”¨é—¨æ§ä¼˜åŒ–çš„EMGè¯„ä¼°
python scripts/eval_emg.py --use-knowledge-gating --use-consistency-gating
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®éªŒæ€»ç»“**: `å®éªŒæ€»ç»“.md`
- **å®éªŒåˆ†æ**: `å®éªŒåˆ†æ.md`
- **è¿è¡ŒæŒ‡å—**: `äº‘ç«¯è¿è¡Œ.md`
- **EMG Î±å®šä¹‰**: `EMG_Î±å®šä¹‰è¯´æ˜.md`

