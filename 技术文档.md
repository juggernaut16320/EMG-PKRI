# æŠ€æœ¯æ–‡æ¡£

**æœ€åæ›´æ–°**ï¼š2025-12-14  
**é¡¹ç›®**ï¼šåŸºäºä¸ç¡®å®šæ€§å»ºæ¨¡çš„EMGèåˆæœºåˆ¶

---

## ğŸ“‹ ç›®å½•ç»“æ„

```
project/
â”œâ”€â”€ data/                  # æ•°æ®ç›®å½•
â”œâ”€â”€ scripts/               # æ‰€æœ‰è„šæœ¬
â”œâ”€â”€ tests/                 # å•å…ƒæµ‹è¯•
â”œâ”€â”€ configs/               # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ lexicons/          # è¯è¡¨ï¼ˆDay6ç”Ÿæˆï¼‰
â”œâ”€â”€ output/                # è¾“å‡ºç›®å½•
â”œâ”€â”€ checkpoints/           # æ¨¡å‹checkpoint
â””â”€â”€ requirements.txt
```

---

## Day1: æ•°æ®å‡†å¤‡

### ä»»åŠ¡ç›®æ ‡
æ„å»ºå®Œæ•´æ•°æ®é›†ï¼šæ•°æ®æ¸…æ´—ã€æ ‡ç­¾æ ‡æ³¨ã€æ•°æ®é›†åˆ’åˆ†ã€‚

### æ ¸å¿ƒè„šæœ¬
- `txt_to_jsonl.py`: TXTè½¬JSONL
- `data_cleaner.py`: æ•°æ®æ¸…æ´—
- `coarse_label.py`: ä¸»æ ‡ç­¾æ ‡æ³¨ï¼ˆæ•æ„Ÿ/éæ•æ„Ÿï¼‰
- `subtype_assign.py`: å­æ ‡ç­¾æ ‡æ³¨ï¼ˆporn/politics/abuse/otherï¼‰
- `dataset_split.py`: æ•°æ®é›†åˆ’åˆ†ï¼ˆtrain/dev/testï¼‰
- `hardset_maker.py`: å›°éš¾é›†æ„å»º

### è¾“å…¥è¾“å‡º

**è¾“å…¥**ï¼š`data/unprocessed/*.txt`

**è¾“å‡º**ï¼š
- `data/train.jsonl`: 39,583 æ¡
- `data/dev.jsonl`: 4,948 æ¡
- `data/test.jsonl`: 4,948 æ¡
- `data/hard_eval_set.jsonl`: å›°éš¾æ ·æœ¬é›†

### å…³é”®é…ç½®
- **LLMæ¨¡å‹**: `gemma-3-27b-it`ï¼ˆæ‰¹é‡å¤„ç†ï¼Œ30 RPMé™åˆ¶ï¼‰
- **æ•°æ®åˆ’åˆ†**: 8:1:1 (stratify by coarse label)

---

## Day2: Baseline è®­ç»ƒ

### ä»»åŠ¡ç›®æ ‡
è®­ç»ƒäºŒåˆ†ç±»åŸºçº¿æ¨¡å‹ï¼ˆæ•æ„Ÿ/éæ•æ„Ÿï¼‰ã€‚

### æ ¸å¿ƒè„šæœ¬
- `baseline_train.py`: Baselineæ¨¡å‹è®­ç»ƒ

### å…³é”®å‚æ•°
- **æ¨¡å‹**: Qwen-1.7B + LoRAå¾®è°ƒ
- **ä»»åŠ¡**: äºŒåˆ†ç±»ï¼ˆcoarse labelï¼‰
- **è®­ç»ƒ**: 3 epochs

### å®éªŒç»“æœ
- **éªŒè¯é›† F1**: 88.3%
- **éªŒè¯é›† Accuracy**: 84.6%
- **éªŒè¯é›† Precision**: 87.1%
- **éªŒè¯é›† Recall**: 89.6%

### è¾“å‡º
- `checkpoints/baseline-lora/`: LoRAé€‚é…å™¨checkpoint

---

## Day3: Baseline è¯„ä¼°

### ä»»åŠ¡ç›®æ ‡
åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°Baselineæ¨¡å‹æ€§èƒ½ã€‚

### æ ¸å¿ƒè„šæœ¬
- `eval_baseline.py`: Baselineè¯„ä¼°

### å®éªŒç»“æœ
- **æµ‹è¯•é›† F1**: 89.13%
- **æµ‹è¯•é›† Accuracy**: 85.95%
- **æµ‹è¯•é›† Precision**: 89.42%
- **æµ‹è¯•é›† Recall**: 88.83%
- **é«˜ç½®ä¿¡é”™è¯¯æ ·æœ¬**: 444 ä¸ªï¼ˆç½®ä¿¡åº¦ â‰¥ 0.8ï¼‰

---

## Day4: ä¸ç¡®å®šæ€§åˆ†æ

### ä»»åŠ¡ç›®æ ‡
åˆ†ææ¨¡å‹ä¸ç¡®å®šæ€§ u ä¸é”™è¯¯ç‡çš„ç›¸å…³æ€§ã€‚

### æ ¸å¿ƒè„šæœ¬
- `uncertainty_analysis.py`: ä¸ç¡®å®šæ€§åˆ†æ

### ä¸ç¡®å®šæ€§å®šä¹‰
```
u = 1 - max_c pÎ¸(c|x)
```
å…¶ä¸­ `pÎ¸(c|x)` æ˜¯æ¨¡å‹é¢„æµ‹æ¦‚ç‡ã€‚

### å®éªŒç»“æœ
- **ç›¸å…³ç³»æ•°**: 0.8379ï¼ˆå¼ºæ­£ç›¸å…³ï¼‰
- **åˆ†æ¡¶ç»Ÿè®¡**:
  - ä½uï¼ˆu < 0.1ï¼‰: 79.1% æ ·æœ¬ï¼Œé”™è¯¯ç‡ 8.56%
  - ä¸­uï¼ˆ0.1 â‰¤ u < 0.3ï¼‰: 13.0% æ ·æœ¬ï¼Œé”™è¯¯ç‡ 33.64%
  - é«˜uï¼ˆu â‰¥ 0.3ï¼‰: 7.9% æ ·æœ¬ï¼Œé”™è¯¯ç‡ 33-100%

### è¾“å‡º
- `output/dev_with_uncertainty.jsonl`: devé›†+ä¸ç¡®å®šæ€§
- `output/test_with_uncertainty.jsonl`: testé›†+ä¸ç¡®å®šæ€§
- `output/uncertainty_buckets.csv`: åˆ†æ¡¶ç»Ÿè®¡

---

## Day5: æ ¡å‡†åˆ†æ

### ä»»åŠ¡ç›®æ ‡
åˆ†æBaselineæ¨¡å‹çš„æ ¡å‡†è¯¯å·®ï¼ˆECE/MCEï¼‰ã€‚

### æ ¸å¿ƒè„šæœ¬
- `calibration_analysis.py`: æ ¡å‡†åˆ†æ

### çŠ¶æ€
âš ï¸ è„šæœ¬å·²å®Œæˆï¼Œå¾…è¿è¡Œï¼ˆå¯é€‰ä»»åŠ¡ï¼‰

---

## Day6: çŸ¥è¯†åéªŒæ„å»º

### ä»»åŠ¡ç›®æ ‡
æ„å»ºè§„åˆ™çŸ¥è¯†åéªŒ qâ‚€(c|z)ã€‚

### æ ¸å¿ƒè„šæœ¬
- `lexicon_generator.py`: è¯è¡¨ç”Ÿæˆï¼ˆä½¿ç”¨LLMï¼‰
- `q0_builder.py`: qâ‚€åéªŒæ„å»º

### è¯è¡¨ç”Ÿæˆ
- **porn**: 7,390 ä¸ªè¯
- **politics**: 17,337 ä¸ªè¯
- **abuse**: 11,283 ä¸ªè¯
- **æ€»è®¡**: 36,010 ä¸ªè¯

### qâ‚€è®¡ç®—é€»è¾‘
1. è¯è¡¨åŒ¹é…ï¼ˆä½¿ç”¨pyahocorasickè‡ªåŠ¨æœºåŠ é€Ÿï¼‰
2. åŒ¹é…åˆ†æ•°è®¡ç®—ï¼š`match_score = Î£(weight Ã— count)`
3. æ¦‚ç‡æ˜ å°„ï¼š`p_sensitive = base + (max - base) Ã— tanh(match_score Ã— scale)`

### å…³é”®å‚æ•°ï¼ˆä¼˜åŒ–åï¼‰
- `base_sensitive_prob`: 0.1
- `max_sensitive_prob`: 0.75ï¼ˆä»0.95é™ä½ï¼‰
- `min_matches_for_sensitive`: 2ï¼ˆä»1æé«˜ï¼‰
- `politics_weight`: 0.6ï¼ˆä»0.8é™ä½ï¼‰
- `abuse_weight`: 0.5ï¼ˆä»0.6é™ä½ï¼‰
- `tanhç¼©æ”¾å› å­`: 5ï¼ˆä»10é™ä½ï¼‰

### è¾“å‡º
- `data/q0_train.jsonl`: trainé›†qâ‚€
- `data/q0_dev.jsonl`: devé›†qâ‚€
- `data/q0_test.jsonl`: testé›†qâ‚€

---

## Day7: EMG Î± æœç´¢

### ä»»åŠ¡ç›®æ ‡
ä¸ºæ¯ä¸ªä¸ç¡®å®šæ€§bucketæœç´¢æœ€ä¼˜èåˆæƒé‡ Î±*ã€‚

### æ ¸å¿ƒè„šæœ¬
- `emg_bucket_search.py`: åˆ†æ¡¶Î±æœç´¢

### EMGèåˆå…¬å¼
```
p_emg(c|x) = Î± Ã— p(c|x) + (1 - Î±) Ã— qâ‚€(c|z)
```
- `p(c|x)`: baselineæ¨¡å‹é¢„æµ‹æ¦‚ç‡
- `qâ‚€(c|z)`: çŸ¥è¯†åéªŒ
- `Î±`: èåˆæƒé‡ï¼ˆÎ±è¶Šå¤§è¶Šä¿¡ä»»æ¨¡å‹ï¼‰

### æœç´¢ç­–ç•¥
- å¯¹æ¯ä¸ªu bucketï¼Œæšä¸¾ Î± âˆˆ {0, 0.25, 0.5, 0.75, 1}
- è®¡ç®—F1å’ŒNLL
- é€‰æ‹©ä½¿F1æœ€å¤§çš„Î±*

### å®éªŒç»“æœ

| Bucket | u_mean | n_samples | alpha_star | è¯´æ˜ |
|--------|--------|-----------|------------|------|
| 0 | 0.016 | 3,912 | 0.75 | ä½uï¼Œä¿¡ä»»æ¨¡å‹ |
| 1 | 0.146 | 368 | 0.25 | ä¸­ç­‰uï¼Œå¹³è¡¡ |
| 2 | 0.248 | 284 | 0.50 | ä¸­ç­‰uï¼Œå¹³è¡¡ |
| 3 | 0.349 | 207 | 0.00 | é«˜uï¼Œä¿¡ä»»çŸ¥è¯† |
| 4 | 0.451 | 177 | 0.00 | é«˜uï¼Œä¿¡ä»»çŸ¥è¯† |

**ç»“è®º**ï¼šâœ… Î±*ç¬¦åˆç†è®ºé¢„æœŸï¼ˆä½uæ—¶Î±å¤§ï¼Œé«˜uæ—¶Î±å°ï¼‰

### è¾“å‡º
- `output/bucket_alpha_star.csv`: æ¯ä¸ªbucketçš„æœ€ä¼˜Î±*

---

## Day8: PAV æ‹Ÿåˆ

### ä»»åŠ¡ç›®æ ‡
ä½¿ç”¨PAVä¿åºå›å½’æ‹Ÿåˆå•è°ƒé€’å‡çš„Î±(u)å‡½æ•°ã€‚

### æ ¸å¿ƒè„šæœ¬
- `emg_fit_alpha_u.py`: PAVæ‹Ÿåˆ

### PAVç®—æ³•
- **ç›®æ ‡**: ä»ç¦»æ•£çš„(u, Î±*)ç‚¹æ‹Ÿåˆå•è°ƒé€’å‡å‡½æ•°
- **æ–¹æ³•**: Pool Adjacent Violatorsç®—æ³•
- **çº¦æŸ**: Î±(u) å•è°ƒé€’å‡ï¼ˆuå¢å¤§ï¼ŒÎ±å‡å°ï¼‰

### å®éªŒç»“æœ
- **æŸ¥è¡¨ç‚¹æ•°**: 100ä¸ª
- **uèŒƒå›´**: [0.0156, 0.4510]
- **Î±èŒƒå›´**: [0.0000, 0.7500]
- **å•è°ƒæ€§éªŒè¯**: âœ… é€šè¿‡

### è¾“å‡º
- `output/alpha_u_lut.json`: Î±(u)æŸ¥è¡¨ï¼ˆ100ä¸ªç‚¹ï¼‰
- `output/alpha_u_curve.png`: å¯è§†åŒ–æ›²çº¿

---

## Day9: EMG æ•ˆæœéªŒè¯ä¸é—¨æ§ä¼˜åŒ–

### ä»»åŠ¡ç›®æ ‡
1. è¯„ä¼°EMGèåˆåœ¨æµ‹è¯•é›†ä¸Šçš„æ•ˆæœ
2. å®æ–½é—¨æ§æœºåˆ¶ä¼˜åŒ–ï¼ˆçŸ¥è¯†é˜ˆå€¼é—¨æ§ã€ä¸€è‡´æ€§é—¨æ§ï¼‰

### æ ¸å¿ƒè„šæœ¬
- `eval_emg.py`: EMGæ•ˆæœè¯„ä¼°

### è¯„ä¼°æ–¹æ³•
1. **Baseline**: ä»…ä½¿ç”¨æ¨¡å‹é¢„æµ‹
2. **Fixed Alpha**: å›ºå®šÎ±èåˆï¼ˆÎ±=0.5ï¼‰
3. **EMG**: ä½¿ç”¨Î±(u)å‡½æ•°åŠ¨æ€èåˆ

### è¯„ä¼°æŒ‡æ ‡
- **F1**: åˆ†ç±»å‡†ç¡®ç‡
- **NLL**: è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼ˆæ¦‚ç‡è´¨é‡ï¼‰
- **ECE**: é¢„æœŸæ ¡å‡†è¯¯å·®ï¼ˆæ ¡å‡†è´¨é‡ï¼‰

### å®éªŒç»“æœï¼ˆæœ€ç»ˆ - å¸¦é—¨æ§ä¼˜åŒ–ï¼‰

**å…¨å±€å¯¹æ¯”ï¼ˆçŸ¥è¯†é˜ˆå€¼é—¨æ§ + ä¸€è‡´æ€§é—¨æ§ï¼‰**ï¼š
| æ–¹æ³• | F1 | NLL | ECE |
|------|----|-----|-----|
| Baseline | 89.13% | 0.4001 | 0.0730 |
| EMGï¼ˆå¸¦é—¨æ§ï¼‰ | **89.13%** | **0.3871** | **0.0737** |
| **æ”¹è¿›** | **0.00%** âœ… | **-3.26%** âœ… | **-1.05%** âœ… |

**ä¸ç¡®å®šæ€§åˆ‡ç‰‡è¯„ä¼°ï¼ˆå¸¦é—¨æ§ï¼‰**ï¼š
| åˆ‡ç‰‡ | æ ·æœ¬å æ¯” | F1å˜åŒ– | NLLå˜åŒ– | ECEå˜åŒ– |
|------|---------|--------|---------|---------|
| ä½uï¼ˆu < 0.1ï¼‰ | 79% | 0% âœ… | **-6.5%** âœ… | **-7.9%** âœ… |
| ä¸­ç­‰uï¼ˆ0.1â‰¤u<0.3ï¼‰ | 13% | 0% âœ… | +1.5% âš ï¸ | +8.1% âš ï¸ |
| é«˜uï¼ˆu â‰¥ 0.3ï¼‰ | 8% | 0% âœ… | +3.8% âš ï¸ | **-86.8%** âœ… |

### è¾“å‡º
- `output/emg_comparison_table.csv`: æ–¹æ³•å¯¹æ¯”è¡¨
- `output/emg_comparison_charts.png`: å¯è§†åŒ–å›¾è¡¨

### Day9 æ”¹è¿›ï¼šé—¨æ§æœºåˆ¶ä¼˜åŒ–

#### çŸ¥è¯†é˜ˆå€¼é—¨æ§
- **ç›®æ ‡**ï¼šé¿å…ä½¿ç”¨å¼±çŸ¥è¯†ï¼ˆqâ‚€ç½®ä¿¡åº¦ä½æ—¶ï¼‰
- **æ–¹æ³•**ï¼šåœ¨éªŒè¯é›†ä¸Šæœç´¢æœ€ä¼˜é˜ˆå€¼ï¼ˆè€Œéç¡¬ç¼–ç ï¼‰
- **è§„åˆ™**ï¼šå½“ `max(qâ‚€) < learned_threshold` æ—¶ï¼Œè®¾ç½® Î±=1.0
- **è„šæœ¬**ï¼š`scripts/search_knowledge_threshold.py`

#### ä¸€è‡´æ€§é—¨æ§ï¼ˆå·²å®æ–½ï¼Œæ•ˆæœæ˜¾è‘—ï¼‰
- **ç›®æ ‡**ï¼šé¿å…qâ‚€ä¸æ¨¡å‹é¢„æµ‹å†²çªæ—¶å¼•å…¥å™ªå£°
- **è§„åˆ™**ï¼šå½“ `argmax(p) != argmax(qâ‚€)` æ—¶ï¼Œè®¾ç½® Î±=1.0ï¼ˆå®Œå…¨ä¿¡ä»»æ¨¡å‹ï¼‰
- **å®ç°**ï¼šåœ¨ `eval_emg.py` ä¸­æ·»åŠ ä¸€è‡´æ€§æ£€æŸ¥é€»è¾‘
- **æ•ˆæœ**ï¼šå®Œå…¨ä¿æŒF1æ€§èƒ½ï¼ˆ89.13%ï¼‰ï¼ŒåŒæ—¶æ”¹å–„æ¦‚ç‡è´¨é‡ï¼ˆNLLé™ä½3.26%ï¼‰

---

## Day10: PKRIï¼ˆçŸ¥è¯†å¯ä¿¡åº¦å»ºæ¨¡ï¼‰æ„å»º

### ä»»åŠ¡ç›®æ ‡
å°† qâ‚€ å‡çº§ä¸ºå¸¦å¯ä¿¡åº¦å»ºæ¨¡çš„ q_PKRIï¼ˆcoarse äºŒåˆ†ç±»ï¼‰ï¼Œé€šè¿‡æœºå™¨å­¦ä¹ æ–¹æ³•å»ºæ¨¡çŸ¥è¯†è¾¹çš„å¯ä¿¡åº¦ã€‚

### æ–¹æ¡ˆé€‰å‹
**å®æ–½æ–¹æ¡ˆä¸€ï¼ˆç®€åŒ–ç‰ˆï¼‰**ï¼šå¿«é€ŸéªŒè¯PKRIæ ¸å¿ƒåŠŸèƒ½
- ç‰¹å¾ï¼šè¯è¡¨å‘½ä¸­ã€å­æ ‡ç­¾åŒ¹é…ã€åŒ¹é…å¯†åº¦ã€æºå›¾è°±ç½®ä¿¡ï¼ˆå…±21ä¸ªç‰¹å¾ï¼‰
- æ¨¡å‹ï¼šé€»è¾‘å›å½’ï¼ˆLRï¼‰
- æ ¡å‡†ï¼šæ¸©åº¦ç¼©æ”¾ï¼ˆPlatt scalingï¼‰

### æ ¸å¿ƒè„šæœ¬
- `pkri_feature_builder.py`: PKRIç‰¹å¾æ„å»º
- `pkri_train.py`: PKRIæ¨¡å‹è®­ç»ƒå’Œq_PKRIç”Ÿæˆ

### ç‰¹å¾è®¾è®¡

#### 1. è¯è¡¨å‘½ä¸­ç‰¹å¾ï¼ˆ8ä¸ªï¼‰
- `lexicon_match_porn/politics/abuse`: å„ç±»åˆ«åŒ¹é…è¯æ•°é‡ï¼ˆ3ä¸ªï¼‰
- `total_matches`: æ€»åŒ¹é…æ•°ï¼ˆ1ä¸ªï¼‰
- `match_ratio`: åŒ¹é…è¯æ•° / æ–‡æœ¬è¯æ•°ï¼ˆ1ä¸ªï¼‰
- `has_porn/politics/abuse_match`: æ˜¯å¦åŒ¹é…ï¼ˆ0/1ï¼‰ï¼ˆ3ä¸ªï¼‰

#### 2. å­æ ‡ç­¾åŒ¹é…ç‰¹å¾ï¼ˆ4ä¸ªï¼‰
- `subtype_match_porn/politics/abuse`: å­æ ‡ç­¾ä¸è¯è¡¨åŒ¹é…ä¸€è‡´æ€§ï¼ˆ0/1ï¼‰ï¼ˆ3ä¸ªï¼‰
- `subtype_match_score`: åŒ¹é…ä¸€è‡´æ€§åˆ†æ•°ï¼ˆ0-1ï¼‰ï¼ˆ1ä¸ªï¼‰

#### 3. åŒ¹é…å¯†åº¦ç‰¹å¾ï¼ˆ5ä¸ªï¼‰
- `match_density`: åŒ¹é…è¯æ•° / æ–‡æœ¬é•¿åº¦ï¼ˆ1ä¸ªï¼‰
- `match_span_ratio`: åŒ¹é…è·¨åº¦æ¯”ä¾‹ï¼ˆ1ä¸ªï¼‰
- `max_match_category_porn/politics/abuse`: åŒ¹é…æ•°æœ€å¤šçš„ç±»åˆ«ï¼ˆone-hotç¼–ç ï¼‰ï¼ˆ3ä¸ªï¼‰

#### 4. æºå›¾è°±ç½®ä¿¡ç‰¹å¾ï¼ˆ4ä¸ªï¼‰
- `source_confidence_porn/politics/abuse`: å„ç±»åˆ«è¯è¡¨ç½®ä¿¡åº¦ï¼ˆå›ºå®šå€¼ï¼‰ï¼ˆ3ä¸ªï¼‰
- `weighted_source_confidence`: åŠ æƒå¹³å‡ç½®ä¿¡åº¦ï¼ˆ1ä¸ªï¼‰

**æ€»ç‰¹å¾æ•°**ï¼š21ä¸ªï¼ˆ8+4+5+4ï¼‰

### PKRIæ¨¡å‹è®­ç»ƒæµç¨‹

1. **ç‰¹å¾æ„å»º**ï¼š
   ```bash
   python scripts/pkri_feature_builder.py \
       --dataset-file data/train_with_subtypes.jsonl \
       --lexicon-dir configs/lexicons \
       --output-file output/pkri_features_train.csv
   ```

2. **æ¨¡å‹è®­ç»ƒ**ï¼š
   - è®­ç»ƒLRæ¨¡å‹é¢„æµ‹çŸ¥è¯†å¯ä¿¡åº¦ï¼ˆä½¿ç”¨coarse_labelä½œä¸ºæ ‡ç­¾ï¼‰
   - åœ¨éªŒè¯é›†ä¸Šä½¿ç”¨Platt scalingè¿›è¡Œæ ¡å‡†

3. **q_PKRIç”Ÿæˆ**ï¼š
   - ä½¿ç”¨æ¨¡å‹é¢„æµ‹çŸ¥è¯†å¯ä¿¡åº¦
   - æ ¹æ®åŒ¹é…ç»“æœå’Œå¯ä¿¡åº¦æ„å»ºq_PKRIåéªŒ
   - å…¬å¼ï¼š`p_sensitive = base + (max - base) Ã— match_strength Ã— confidence`

### q_PKRIæ„å»ºé€»è¾‘

**åŸºäºå¯ä¿¡åº¦çš„åŠ æƒèåˆ**ï¼š
```python
# 1. è®¡ç®—åŒ¹é…å¼ºåº¦ï¼ˆç±»ä¼¼qâ‚€ï¼‰
match_strength = tanh(match_score * 5)  # æ˜ å°„åˆ°[0, 1]

# 2. åº”ç”¨å¯ä¿¡åº¦åŠ æƒ
p_sensitive = base_prob + (max_prob - base_prob) Ã— match_strength Ã— confidence
```

- `confidence`é«˜æ—¶ï¼Œæ›´ä¿¡ä»»åŒ¹é…ç»“æœ
- `confidence`ä½æ—¶ï¼Œæ›´æ¥è¿‘åŸºç¡€æ¦‚ç‡

### è¾“å…¥æ–‡ä»¶
- `data/train/dev/test_with_subtypes.jsonl`: æ•°æ®é›†ï¼ˆéœ€åŒ…å«subtype_labelå­—æ®µï¼‰
- `configs/lexicons/*.txt`: è¯è¡¨æ–‡ä»¶ï¼ˆDay6è¾“å‡ºï¼‰

### è¾“å‡ºæ–‡ä»¶
- `output/pkri_features_train/dev/test.csv`: PKRIç‰¹å¾æ–‡ä»¶
- `output/pkri_model.pkl`: è®­ç»ƒå¥½çš„PKRIæ¨¡å‹
- `output/pkri_model_config.json`: æ¨¡å‹é…ç½®ï¼ˆç‰¹å¾åˆ—è¡¨ã€è¯„ä¼°æŒ‡æ ‡ç­‰ï¼‰
- `data/qpkri_train/dev/test.jsonl`: q_PKRIåéªŒæ–‡ä»¶ï¼ˆæ ¼å¼ä¸qâ‚€ä¸€è‡´ï¼‰

**q_PKRIæ–‡ä»¶æ ¼å¼**ï¼š
```json
{
  "id": "s0",
  "qpkri": [0.2, 0.8],  // [p_non_sensitive, p_sensitive]
  "confidence": 0.75    // çŸ¥è¯†å¯ä¿¡åº¦ï¼ˆæ ¡å‡†åï¼‰
}
```

### è¿è¡Œæµç¨‹

```bash
# æ­¥éª¤1: æ„å»ºç‰¹å¾
python scripts/pkri_feature_builder.py \
    --dataset-file data/train_with_subtypes.jsonl \
    --lexicon-dir configs/lexicons \
    --output-file output/pkri_features_train.csv

python scripts/pkri_feature_builder.py \
    --dataset-file data/dev_with_subtypes.jsonl \
    --lexicon-dir configs/lexicons \
    --output-file output/pkri_features_dev.csv

python scripts/pkri_feature_builder.py \
    --dataset-file data/test_with_subtypes.jsonl \
    --lexicon-dir configs/lexicons \
    --output-file output/pkri_features_test.csv

# æ­¥éª¤2: è®­ç»ƒæ¨¡å‹å¹¶ç”Ÿæˆq_PKRI
python scripts/pkri_train.py \
    --train-features output/pkri_features_train.csv \
    --dev-features output/pkri_features_dev.csv \
    --test-features output/pkri_features_test.csv \
    --train-dataset data/train_with_subtypes.jsonl \
    --dev-dataset data/dev_with_subtypes.jsonl \
    --test-dataset data/test_with_subtypes.jsonl \
    --model-type lr \
    --calibration-method temperature \
    --output-model output/pkri_model.pkl \
    --output-qpkri-dir data \
    --output-metrics output/pkri_model_metrics.json
```

### qâ‚€ vs q_PKRI

| ç‰¹æ€§ | qâ‚€ | q_PKRI |
|------|----|----|
| æ–¹æ³• | è§„åˆ™åŸºç¡€ï¼ˆè¯è¡¨åŒ¹é…+å‚æ•°æ˜ å°„ï¼‰ | å­¦ä¹ åŸºç¡€ï¼ˆç‰¹å¾+æ¨¡å‹é¢„æµ‹ï¼‰ |
| ç‰¹å¾ | ç®€å•åŒ¹é…è®¡æ•° | å¤šç»´ç‰¹å¾ï¼ˆ19ä¸ªï¼‰ |
| å¯ä¿¡åº¦ | æ— æ˜¾å¼å»ºæ¨¡ | æ˜¾å¼å»ºæ¨¡ï¼ˆLRé¢„æµ‹ï¼‰ |
| æ ¡å‡† | æ—  | Platt scalingæ ¡å‡† |
| å¯è§£é‡Šæ€§ | é«˜ï¼ˆè§„åˆ™æ¸…æ™°ï¼‰ | ä¸­ï¼ˆç‰¹å¾å¯è§£é‡Šï¼Œæ¨¡å‹é»‘ç›’ï¼‰ |
| éƒ¨ç½²å¤æ‚åº¦ | ä½ï¼ˆçº¯è®¡ç®—ï¼‰ | ä¸­ï¼ˆéœ€è¦æ¨¡å‹æ¨ç†ï¼‰ |

---

## ğŸ”§ å…³é”®é…ç½®å‚æ•°

### qâ‚€æ„å»ºå‚æ•°ï¼ˆconfigs/config.yamlï¼‰

```yaml
q0:
  base_sensitive_prob: 0.1
  max_sensitive_prob: 0.75      # ä»0.95é™ä½
  min_matches_for_sensitive: 2  # ä»1æé«˜
  politics_weight: 0.6          # ä»0.8é™ä½
  abuse_weight: 0.5             # ä»0.6é™ä½
```

### æ¨¡å‹é…ç½®

```yaml
model:
  name_or_path: /mnt/workspace/models/qwen/Qwen3-1___7B
  use_lora: true
  lora_r: 8
  lora_alpha: 16
```

---

## ğŸ“ æ•°æ®æ ¼å¼

### JSONLæ ‡å‡†æ ¼å¼

```json
{
  "id": "s1234",
  "text": "æ–‡æœ¬å†…å®¹",
  "coarse_label": 1,
  "subtypes": ["porn"],
  "pred_probs": [0.2, 0.8],
  "uncertainty": 0.15,
  "q0": [0.1, 0.9]
}
```

---

## ğŸš€ è¿è¡Œæµç¨‹

### å®Œæ•´å®éªŒæµç¨‹

```bash
# Day1: æ•°æ®å‡†å¤‡
python scripts/txt_to_jsonl.py
python scripts/data_cleaner.py
python scripts/coarse_label.py
python scripts/subtype_assign.py
python scripts/dataset_split.py

# Day2: è®­ç»ƒBaseline
python scripts/baseline_train.py

# Day3: è¯„ä¼°Baseline
python scripts/eval_baseline.py

# Day4: ä¸ç¡®å®šæ€§åˆ†æ
python scripts/uncertainty_analysis.py --dev-file dev.jsonl

# Day6: æ„å»ºqâ‚€
python scripts/lexicon_generator.py
python scripts/q0_builder.py --datasets train dev test

# Day7: æœç´¢Î±*
python scripts/emg_bucket_search.py

# Day8: æ‹ŸåˆÎ±(u)
python scripts/emg_fit_alpha_u.py

# Day9: è¯„ä¼°EMG
python scripts/eval_emg.py

# Day9 æ”¹è¿›ï¼šæœç´¢çŸ¥è¯†é˜ˆå€¼
python scripts/search_knowledge_threshold.py

# Day9 æ”¹è¿›ï¼šä½¿ç”¨é—¨æ§ä¼˜åŒ–çš„EMGè¯„ä¼°
python scripts/eval_emg.py --use-knowledge-gating --use-consistency-gating

# Day10: æ„å»ºPKRIç‰¹å¾
python scripts/pkri_feature_builder.py --dataset-file data/train_with_subtypes.jsonl --lexicon-dir configs/lexicons --output-file output/pkri_features_train.csv
python scripts/pkri_feature_builder.py --dataset-file data/dev_with_subtypes.jsonl --lexicon-dir configs/lexicons --output-file output/pkri_features_dev.csv
python scripts/pkri_feature_builder.py --dataset-file data/test_with_subtypes.jsonl --lexicon-dir configs/lexicons --output-file output/pkri_features_test.csv

# Day10: è®­ç»ƒPKRIæ¨¡å‹å¹¶ç”Ÿæˆq_PKRI
python scripts/pkri_train.py \
    --train-features output/pkri_features_train.csv \
    --dev-features output/pkri_features_dev.csv \
    --test-features output/pkri_features_test.csv \
    --train-dataset data/train_with_subtypes.jsonl \
    --dev-dataset data/dev_with_subtypes.jsonl \
    --test-dataset data/test_with_subtypes.jsonl \
    --model-type lr \
    --calibration-method temperature \
    --output-model output/pkri_model.pkl \
    --output-qpkri-dir data
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®éªŒæ€»ç»“**: `å®éªŒæ€»ç»“.md`
- **å®éªŒåˆ†æ**: `å®éªŒåˆ†æ.md`
- **è¿è¡ŒæŒ‡å—**: `äº‘ç«¯è¿è¡Œ.md`
- **EMG Î±å®šä¹‰**: `EMG_Î±å®šä¹‰è¯´æ˜.md`

