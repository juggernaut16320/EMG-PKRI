# 高不确定性切片结果分析

**分析时间**：2025-12-14  
**数据来源**：运行 `eval_emg.py` 的切片评估结果

---

## 📊 切片评估结果

### 整体结果对比

| 方法 | F1 | NLL | ECE | 样本数 |
|------|----|-----|-----|--------|
| **Baseline** | 89.13% | 0.4001 | 0.0730 | 4948 |
| **EMG** | 88.13% | 0.3892 | 0.0648 | 4948 |

**全局改进**：
- ✅ NLL 降低 2.72%
- ✅ ECE 降低 11.16%
- ❌ F1 下降 1.11%

---

### 按不确定性切片详细结果

#### 1. 低不确定性切片（u < 0.1，79% 样本）

| 方法 | F1 | NLL | ECE | 样本数 |
|------|----|-----|-----|--------|
| Baseline | 94.21% | 0.3193 | 0.0635 | 3913 |
| EMG | 94.21% | 0.2815 | 0.0684 | 3913 |

**关键发现**：
- ✅ **F1 完全保持**：94.21% 不变
- ✅ **NLL 显著改善**：0.3193 → 0.2815（降低 11.8%）
- ⚠️ ECE 略有增加：0.0635 → 0.0684（增加 7.7%）

**结论**：在低不确定性区间，EMG 完美保持了分类性能，同时显著改善了概率质量。这符合理论预期（低 u 时 α 大，更信任模型）。

---

#### 2. 中等不确定性切片（0.1 ≤ u < 0.3，13% 样本）

| 方法 | F1 | NLL | ECE | 样本数 |
|------|----|-----|-----|--------|
| Baseline | 67.95% | 0.7143 | 0.1436 | 653 |
| EMG | 58.54% | 0.7188 | 0.1369 | 653 |

**关键发现**：
- ❌ **F1 显著下降**：67.95% → 58.54%（下降 9.41%）
- ❌ **NLL 略有增加**：0.7143 → 0.7188（增加 0.6%）
- ✅ ECE 略有改善：0.1436 → 0.1369（降低 4.7%）

**问题分析**：
- 在中等不确定性区间，EMG 的表现不佳
- F1 显著下降说明 q₀ 在这里引入了噪声
- α* 在 dev 集上搜索的结果可能在 test 集上不是最优

---

#### 3. 高不确定性切片（u ≥ 0.3，8% 样本）

| 方法 | F1 | NLL | ECE | 样本数 |
|------|----|-----|-----|--------|
| Baseline | 55.73% | 0.6906 | 0.0491 | 382 |
| EMG | 56.87% | 0.9296 | 0.2605 | 382 |

**关键发现**：
- ✅ **F1 略有提升**：55.73% → 56.87%（+1.14%）
- ❌ **NLL 大幅增加**：0.6906 → 0.9296（**增加 34.6%**）
- ❌ **ECE 大幅增加**：0.0491 → 0.2605（**增加 430.89%**）

**严重问题**：
- 这是最关键的发现：在高不确定性切片上，虽然 F1 略有提升，但 **NLL 和 ECE 都大幅恶化**
- NLL 增加 34.6% 说明预测概率质量严重下降
- ECE 增加 430.89% 说明校准严重恶化

**根本原因分析**：
1. **q₀ 在高 u 样本上质量差**：
   - 高 u 样本往往是模糊、歧义的文本
   - q₀ 的词表匹配在这些样本上可能产生大量误报
   - 当 α=0.00 时（完全依赖 q₀），噪声被完全放大

2. **α=0.00 的风险**：
   - Day7 结果显示高 u 时 α*=0.00（完全依赖知识）
   - 如果 q₀ 质量差，完全依赖会导致严重的性能下降

3. **测试集 vs Dev 集分布差异**：
   - α* 是在 dev 集上搜索的
   - 测试集的高 u 样本可能与 dev 集不同
   - q₀ 在这些样本上的表现可能更差

---

## 🔍 深度分析

### 为什么低 u 切片表现好？

1. **α 大（接近 0.75）**：主要信任模型，q₀ 权重小（25%）
2. **模型预测准确**：F1=94.21%，说明模型在低 u 样本上已经很准确
3. **q₀ 干扰小**：即使 q₀ 有噪声，25% 的权重影响有限

### 为什么高 u 切片表现差？

1. **α 小（接近 0.00）**：完全依赖 q₀，模型权重为 0
2. **q₀ 质量差**：在高 u 样本上，q₀ 可能产生大量误报
3. **完全信任的风险**：当 α=0.00 时，q₀ 的任何错误都会被放大

### 为什么中等 u 切片也表现差？

1. **α 中等（0.25-0.50）**：模型和知识平衡
2. **q₀ 噪声影响**：中等权重仍会引入显著噪声
3. **可能不是最优**：α* 在 dev 集上搜索，可能在 test 集上不是最优

---

## ✅ 核心结论

### 成功的部分
1. ✅ **低不确定性切片**：EMG 完美保持性能，同时改善概率质量
2. ✅ **全局概率质量**：NLL 和 ECE 整体改善
3. ✅ **理论验证**：不确定性驱动的机制按预期工作（低 u 时 α 大）

### 需要改进的部分
1. ❌ **高不确定性切片**：虽然 F1 略升，但概率质量（NLL/ECE）大幅恶化
2. ❌ **中等不确定性切片**：F1 显著下降
3. ⚠️ **q₀ 质量**：在高 u 样本上，q₀ 可能引入过多噪声

---

## 🎯 改进建议

### 1. 立即实施：一致性门控（P1，推荐）
- **原理**：仅当 `argmax(p) == argmax(q₀)` 时允许 α(u) 生效
- **效果**：可以防止 q₀ 把模型带偏，减少 F1 损失
- **实现**：在 `compute_emg_fusion` 中添加一致性检查

### 2. 立即实施：知识阈值门控（P1，推荐）
- **原理**：当 `max(q₀) < 0.6` 时直接把 α=1.0（完全信任模型）
- **效果**：避免使用弱知识，减少噪声
- **实现**：在融合前检查 q₀ 的置信度

### 3. 优化 q₀ 在高 u 样本上的质量（P2）
- 分析高 u 样本的特征
- 优化词表，减少误报
- 调整 q₀ 概率计算策略

### 4. 重新评估 α* 在高 u 切片上的值（P2）
- 可能不应该完全依赖 q₀（α=0.00）
- 尝试在 test 集上重新搜索最优 α*
- 或使用更保守的 α 值（如最小 α=0.2）

---

## 📝 关键发现总结

1. **EMG 在低 u 切片表现优秀**：完美保持性能，改善概率质量
2. **EMG 在高 u 切片存在严重问题**：虽然 F1 略升，但概率质量大幅恶化
3. **根本原因**：q₀ 在高 u 样本上质量差，当 α=0.00 时完全依赖导致问题放大
4. **解决方案**：需要实施一致性门控或知识阈值门控，避免完全信任低质量 q₀

---

**下一步行动**：实施一致性门控或知识阈值门控，重新运行评估，验证改进效果。

