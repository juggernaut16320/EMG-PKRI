# q0优化总结

**最后更新**：2025-12-15  
**内容**：q0构建、优化、诊断、修复和参数调优的完整记录

---

## 📋 目录

1. [问题诊断](#问题诊断)
2. [已实施的优化](#已实施的优化)
3. [词表优化影响](#词表优化影响)
4. [修复方案与效果](#修复方案与效果)
5. [参数调优方案](#参数调优方案)
6. [后续改进方向](#后续改进方向)

---

## 问题诊断

### 初始问题

**q0平均敏感概率过高（0.82）**，可能导致：
- Precision低，在EMG融合时引入噪声
- 过度敏感，误报率高

### 词表优化后的问题（2025-12-15）

**词表大幅优化**（删除83.7%的词）导致：
- **Recall极低（18.37%）**：漏检81.63%的敏感样本
- **Day7结果异常**：高u时α*=1.00（完全信任模型），与理论相反

### q0质量评估（词表优化后，修复前）

| 指标 | 数值 | 评估 |
|------|------|------|
| **Precision** | 88.70% | ✅ 良好（误报少） |
| **Recall** | **18.37%** | ❌ **极低（漏检严重）** |
| **F1** | 30.44% | ❌ 很低 |
| **Accuracy** | 45.59% | ❌ 低于随机猜测 |
| **平均敏感概率** | 0.1812 | ❌ 过低（< 0.50） |

**混淆矩阵**：
- TP: 589, FN: **2,617**（漏检严重）
- TN: 1,667, FP: 75（误报少）

---

## 已实施的优化

### 第一轮优化（初始参数调整）

1. **降低 max_sensitive_prob**：0.95 → 0.75
2. **提高 min_matches_for_sensitive**：1 → 2（减少单词误匹配）
3. **降低类别权重**：
   - politics_weight: 0.8 → 0.6
   - abuse_weight: 0.6 → 0.5
4. **降低缩放因子**：tanh缩放因子 10 → 5

**改进效果**：
- ✅ NLL: 从增加5.70% → 降低2.72%（改善8.42个百分点）
- ✅ ECE: 从增加39.84% → 降低11.16%（改善51个百分点）
- ⚠️ F1: 从下降0.86% → 下降1.11%（略有恶化）

### 第二轮优化（词表优化后修复）

**方案1：降低匹配要求**（已实施）

调整参数以适应新的词表规模：

```yaml
q0:
  min_matches_for_sensitive: 1  # 从2降低到1（词表小了，降低要求）
  max_sensitive_prob: 0.75      # 保持
  base_sensitive_prob: 0.1      # 保持
```

**修复效果**：

| 指标 | 修复前 | 修复后 | 变化 |
|------|--------|--------|------|
| **Precision** | 88.70% | 86.48% | -2.22% ✅（仍>75%） |
| **Recall** | 18.37% | **35.31%** | **+92%** ✅ |
| **F1** | 30.44% | **50.14%** | **+65%** ✅ |
| **Accuracy** | 45.59% | 54.51% | +19.6% ✅ |
| **平均敏感概率** | 0.1812 | 0.2584 | +42.6% ⚠️（仍<0.30） |

**关键改善**：
- TP从589增加到1132（+543，+92%）
- FN从2617减少到2074（-543，-21%）
- F1提升65%，Recall提升92%

---

## 词表优化影响

### 词表变化统计

| 词表 | 优化前 | 优化后 | 减少比例 |
|------|--------|--------|----------|
| **porn.txt** | 7,390 | ~896 | **-87.9%** |
| **politics.txt** | 17,338 | ~3,703 | **-78.6%** |
| **abuse.txt** | 11,284 | ~1,276 | **-88.7%** |
| **总计** | 36,012 | ~5,875 | **-83.7%** |

### 影响分析

**正面影响**：
- ✅ 去除噪声词（如Android、App等通用词）
- ✅ 提高Precision（88.70% → 86.48%，仍保持高水平）
- ✅ 减少误报（FP较少）

**负面影响**：
- ❌ 匹配率大幅下降
- ❌ Recall极低（18.37%，修复后35.31%）
- ❌ 可能误删了部分有用词

### Day7结果异常原因

**理论预期**：高u时应该信任知识（α→0）

**实际情况**（词表优化后）：
- 高u样本需要知识帮助
- 但q0召回率只有18.37%，漏检严重
- 使用q0反而误导模型
- 结果：只能完全信任模型（α=1.0）

**修复后**：方案一提升了召回率，但需要重新运行Day7验证α*分布是否改善。

---

## 修复方案与效果

### 方案1：降低匹配要求（已实施 ✅）

**调整**：`min_matches_for_sensitive: 2 → 1`

**效果**：
- ✅ Recall提升92%（18.37% → 35.31%）
- ✅ F1提升65%（30.44% → 50.14%）
- ✅ 负面影响可接受（Precision仅下降2.22%）

### 方案2：提高基础概率（备选）

如果方案1效果不够，可以尝试：

```yaml
q0:
  base_sensitive_prob: 0.15  # 从0.1提高到0.15
```

### 方案3：恢复部分被删的词（备选）

如果确认词表过度删除：
1. 分析被删词中是否有高频匹配词
2. 恢复部分有用词
3. 重新优化词表（更保守的策略）

---

## 参数调优方案

### 当前参数状态

```yaml
q0:
  base_sensitive_prob: 0.1         # 基础敏感概率
  max_sensitive_prob: 0.75         # 最大敏感概率
  min_matches_for_sensitive: 1     # 触发敏感的最小匹配数
  porn_weight: 1.0                 # 色情类别权重
  politics_weight: 0.6             # 涉政类别权重
  abuse_weight: 0.5                # 辱骂类别权重
```

### 参数调优脚本

已创建 `scripts/q0_hyperparameter_search.py` 用于系统化参数搜索。

**快速搜索模式**（推荐）：
- 搜索空间：12种组合
- 预计耗时：1-2小时
- 搜索参数：`min_matches`, `max_sensitive_prob`, `base_sensitive_prob`

**完整搜索模式**：
- 搜索空间：384种组合
- 预计耗时：6-12小时
- 搜索所有关键参数

### 调优目标

**方案A：优化q0自身质量**（推荐）
- 目标：最大化q0的F1分数
- 优点：快速迭代，评估简单
- 缺点：可能不是EMG最终效果的最优参数

**方案B：优化EMG最终效果**（理想但复杂）
- 目标：最大化EMG的F1分数
- 优点：直接优化最终目标
- 缺点：需要运行完整Day7流程，耗时

**推荐**：先用方案A找到q0最优参数，再用最优参数运行Day7验证EMG效果。

---

## 后续改进方向

### P0（高优先级）

1. **参数调优**（✅ 快速模式已完成）
   - 使用 `q0_hyperparameter_search.py --mode fast` 完成12种组合搜索
   - **调优结果**：
     - F1: 50.14% → **52.70%**（+5.1%）
     - Recall: 35.31% → **37.96%**（+7.5%）
     - Precision: 86.48% → **86.13%**（-0.4%，保持稳定）
   - **最优参数**：
     - `min_matches_for_sensitive`: 1
     - `max_sensitive_prob`: 0.85
     - `base_sensitive_prob`: 0.15
     - `porn_weight`: 1.0
     - `politics_weight`: 0.6
     - `abuse_weight`: 0.5
   - **分析**：F1提升有限（52.70% < 目标55%），这是rule-based方法的固有局限

2. **重新验证Day7效果**
   - 使用优化后的q0重新运行Day7
   - 验证α*分布是否改善（高u bucket的α*应该降低）

### P1（中优先级）

3. **知识阈值门控优化**（已实施，可进一步优化）
   - 在验证集上搜索最优阈值（而非硬编码）
   - 规则：当 `max(q0) < threshold` 时，设置 α=1.0

4. **一致性门控**（已实施）
   - 当 `argmax(p) != argmax(q0)` 时，设置 α=1.0
   - 避免q0带偏导致的F1损失

### P2（低优先级）

5. **词表进一步优化**
   - 如果参数调优后Recall仍不足，考虑恢复部分被删的词
   - 使用更保守的词表优化策略

6. **更精细的概率计算策略**
   - 考虑词频、PMI、词密度等特征
   - 改进匹配权重计算

---

## 📊 关键指标追踪

### q0质量指标（dev集）

| 阶段 | Precision | Recall | F1 | 平均敏感概率 |
|------|-----------|--------|-----|-------------|
| **初始** | - | - | - | 0.82（过高） |
| **第一轮优化后** | - | - | - | 改善 |
| **词表优化后（修复前）** | 88.70% | 18.37% | 30.44% | 0.1812 |
| **方案一修复后** | 86.48% | 35.31% | 50.14% | 0.2584 |
| **参数调优后（快速模式）** | 86.13% | 37.96% | **52.70%** | 0.3267 |
| **参数调优后（目标）** | >80% | >40% | >55% | 0.25-0.35 |

---

## 🎯 下一步

1. ✅ **运行参数调优**：使用 `q0_hyperparameter_search.py --mode fast`（已完成）
2. ⏳ **应用最优参数**：更新config.yaml（待执行）
3. ⏳ **重新生成q0**：使用最优参数运行Day6（待执行）
4. ⏳ **重新运行Day7**：验证α*分布是否改善（待执行）
5. ⏳ **验证EMG效果**：运行Day9评估（待执行）

### 调参结果总结（2025-12-15）

**快速模式调参完成**：
- 评估了12种参数组合
- 最优F1: **52.70%**（组合#6）
- 相比修复后提升：+5.1%（50.14% → 52.70%）
- 相比初始状态提升：+73%（30.44% → 52.70%）

**Top 3 参数组合**：
1. F1=52.70%: min_matches=1, max_prob=0.85, base_prob=0.15
2. F1=52.55%: min_matches=1, max_prob=0.85, base_prob=0.1
3. F1=51.78%: min_matches=1, max_prob=0.75, base_prob=0.15

**关键发现**：
- `min_matches=1` 优于 `min_matches=2`（召回率更高）
- `max_sensitive_prob=0.85` 表现最好
- `base_sensitive_prob=0.15` 略优于 0.1

**下一步选择**：
- **选项A**：应用最优参数，重新运行Day6-Day9验证EMG效果（推荐）
- **选项B**：运行完整模式调参（384种组合，6-12小时，可能提升有限）
- **选项C**：接受当前结果，q0 F1=52.70%对rule-based方法已属合理

---

## 📝 相关脚本

- `scripts/q0_builder.py`: q0构建脚本
- `scripts/eval_q0.py`: q0质量评估脚本
- `scripts/q0_hyperparameter_search.py`: q0参数调优脚本
- `scripts/clean_lexicon.py`: 词表清理脚本

