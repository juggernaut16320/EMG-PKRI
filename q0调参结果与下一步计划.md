# q0调参结果与下一步计划

**最后更新**：2025-12-15

---

## ✅ 调参结果总结

### 快速模式调参（已完成）

**执行时间**：2025-12-15  
**搜索模式**：fast（12种组合）  
**评估数据集**：dev.jsonl（4,948条样本）

### 最优参数

```yaml
q0:
  min_matches_for_sensitive: 1      # 从当前值保持
  max_sensitive_prob: 0.85          # 从0.75提升到0.85
  base_sensitive_prob: 0.15         # 从0.1提升到0.15
  porn_weight: 1.0                 # 保持
  politics_weight: 0.6              # 保持
  abuse_weight: 0.5                # 保持
```

### 性能对比

| 指标 | 修复后 | 调优后 | 变化 | 评估 |
|------|--------|--------|------|------|
| **Precision** | 86.48% | **86.13%** | -0.35% | ✅ 保持稳定 |
| **Recall** | 35.31% | **37.96%** | +7.5% | ✅ 显著提升 |
| **F1** | 50.14% | **52.70%** | +5.1% | ⚠️ 提升但未达目标55% |
| **Accuracy** | 54.51% | **55.84%** | +2.4% | ✅ 改善 |
| **平均敏感概率** | 0.2584 | **0.3267** | +26.4% | ✅ 更合理 |

### Top 3 参数组合

1. **F1=52.70%** ⭐（最优）
   - min_matches=1, max_prob=0.85, base_prob=0.15
   - Precision=86.13%, Recall=37.96%

2. **F1=52.55%**
   - min_matches=1, max_prob=0.85, base_prob=0.1
   - Precision=86.14%, Recall=37.80%

3. **F1=51.78%**
   - min_matches=1, max_prob=0.75, base_prob=0.15
   - Precision=86.43%, Recall=36.96%

### 关键发现

1. **min_matches=1 优于 min_matches=2**
   - 召回率显著更高（37.96% vs 23.67%）
   - Precision略有下降但仍在可接受范围（86.13% vs 87.14%）

2. **max_sensitive_prob=0.85 表现最好**
   - 相比0.75和0.65，在保持Precision的同时提升Recall

3. **base_sensitive_prob=0.15 略优于 0.1**
   - 提升平均敏感概率，使q0分布更合理

---

## 📊 性能分析

### 为什么F1只有52.70%？

这是**rule-based方法的固有局限**：

1. **Recall上限**：只能匹配词表中的词，无法泛化到新词或变体
2. **Precision-Recall权衡**：提高Recall会降低Precision
3. **词表规模限制**：词表已优化（删除83.7%噪声词），扩展空间有限

**结论**：52.70%的F1对rule-based方法已属合理，这是q0的预期性能范围。

### q0在EMG中的作用

q0不是独立的分类器，而是**知识先验提供者**：

- **作用**：在模型不确定时提供知识先验
- **权重**：在EMG融合中，模型仍占主导（α通常>0.5）
- **评估标准**：应关注EMG最终效果，而非q0独立F1

---

## 🎯 下一步计划

### 选项A：应用最优参数并验证EMG效果（推荐）⭐

**步骤**：

1. **更新config.yaml**
   ```yaml
   q0:
     max_sensitive_prob: 0.85      # 从0.75更新
     base_sensitive_prob: 0.15     # 从0.1更新
     min_matches_for_sensitive: 1  # 保持
   ```

2. **重新生成q0**
   ```bash
   python scripts/q0_builder.py --datasets train dev test
   ```

3. **重新运行Day7（α*搜索）**
   ```bash
   python scripts/emg_bucket_search.py \
       --baseline-file output/dev_with_uncertainty.jsonl \
       --q0-file data/q0_dev.jsonl \
       --bucket-file output/dev_uncertainty_buckets.csv \
       --output-dir output
   ```

4. **重新运行Day8（α(u)拟合）**
   ```bash
   python scripts/emg_fit_alpha_u.py \
       --bucket-alpha-file output/bucket_alpha_star.csv \
       --output-dir output
   ```

5. **重新运行Day9（EMG评估）**
   ```bash
   python scripts/eval_emg.py \
       --baseline-file output/test_with_uncertainty.jsonl \
       --q0-file data/q0_test.jsonl \
       --alpha-u-lut output/alpha_u_lut.json \
       --use-consistency-gating
   ```

**预期收益**：
- 验证优化后的q0是否能改善EMG最终效果
- 检查α*分布是否更符合理论预期（高u时α*降低）
- 验证EMG的F1、NLL、ECE是否改善

**预计耗时**：2-3小时

---

### 选项B：运行完整模式调参（可选）

**适用场景**：
- 如果选项A验证后EMG效果仍不理想
- 如果希望探索更广泛的参数空间

**执行方式**：
```bash
python scripts/q0_hyperparameter_search.py \
    --dataset-file data/dev.jsonl \
    --baseline-file output/dev_with_uncertainty.jsonl \
    --lexicon-dir configs/lexicons \
    --mode full \
    --output-dir output
```

**搜索空间**：
- 384种参数组合
- 包括所有关键参数的完整搜索

**预计耗时**：6-12小时

**预期收益**：
- 可能找到更优参数组合
- 但提升可能有限（rule-based方法固有局限）

**建议**：先执行选项A，如果效果不理想再考虑选项B。

---

### 选项C：接受当前结果（合理选择）

**理由**：
- q0 F1=52.70%对rule-based方法已属合理
- 相比初始状态（30.44%）提升73%，改善显著
- Precision保持86%以上，质量可靠
- 在EMG融合中，q0只是辅助，模型仍占主导

**适用场景**：
- 如果时间有限
- 如果当前q0质量已满足EMG需求
- 如果希望将精力投入到其他优化方向（如PKRI）

---

## 📝 调参结果文件

调参结果已保存到：
- `output/q0_param_search_results.csv`：所有12种组合的详细结果
- `output/q0_best_params.json`：最优参数JSON格式

**查看结果**：
```bash
# 查看最优参数
cat output/q0_best_params.json

# 查看所有结果（Top 10）
head -11 output/q0_param_search_results.csv | column -t -s,
```

---

## 🔍 进一步优化方向（如果选项A效果不理想）

### P1：词表优化
- 如果Recall仍不足，考虑恢复部分被删的词
- 使用更保守的词表优化策略
- 分析漏检样本，补充关键词

### P2：概率计算策略改进
- 考虑词频、PMI、词密度等特征
- 改进匹配权重计算
- 尝试更精细的概率映射函数

### P3：PKRI替代方案
- 如果q0性能无法进一步提升，考虑使用q_PKRI
- PKRI是学习型方法，可能突破rule-based的局限

---

## ✅ 建议

**推荐执行顺序**：

1. **立即执行选项A**：应用最优参数，验证EMG效果
2. **根据结果决定**：
   - 如果EMG效果改善 → 完成，接受当前结果
   - 如果EMG效果不理想 → 考虑选项B（完整模式）或P1-P3优化方向

**时间安排**：
- 选项A：2-3小时（推荐先执行）
- 选项B：6-12小时（可选，根据选项A结果决定）

---

**最后更新**：2025-12-15

