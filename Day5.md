### Day5 è¦å®Œæˆçš„ä»£ç ï¼ˆæ ¡å‡†åˆ†æï¼šReliability Diagram + ECEï¼‰

> **ç¯å¢ƒå‡†å¤‡**ï¼šå¼€å§‹å‰è¯·ç¡®ä¿å·²æ¿€æ´» conda ç¯å¢ƒï¼š`conda activate emgpkri`ï¼ˆæˆ–æ¿€æ´» venvï¼š`source venv/bin/activate`ï¼‰

```text
project/
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ dev.jsonl
â”‚   â”œâ”€â”€ test.jsonl
â”‚
â”œâ”€â”€ checkpoints/
â”‚   â””â”€â”€ baseline-lora/          # Day2 è®­ç»ƒå¥½çš„æ¨¡å‹
â”‚
â”œâ”€â”€ output/
â”‚   â”œâ”€â”€ reliability_diagram.png
â”‚   â”œâ”€â”€ ece_results.json
â”‚   â”œâ”€â”€ calibration_buckets.csv  # å¯é€‰ï¼šè¯¦ç»†çš„åˆ†æ¡¶ç»Ÿè®¡
â”‚
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.yaml
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ calibration_analysis.py
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_calibration_analysis.py
â”‚   â””â”€â”€ test_calibration_analysis_logic.py
â”‚
â””â”€â”€ requirements.txt
```

### `calibration_analysis.py`ï¼ˆæ ¡å‡†åˆ†æå·¥å…·ï¼šReliability Diagram + ECEï¼‰

**åŠŸèƒ½ï¼š**
- åœ¨ dev/test ä¸Šç»˜åˆ¶ Reliability Diagramï¼ˆå¯é æ€§å›¾ï¼‰
- è®¡ç®— ECEï¼ˆExpected Calibration Errorï¼‰å’Œ MCEï¼ˆMaximum Calibration Errorï¼‰
- é‡åŒ– baseline çš„"è¿‡åº¦è‡ªä¿¡"é—®é¢˜ï¼Œä¸ºé—¨æ§/æ ¡å‡†æä¾›åŠ¨æœº

**å…³é”®ç‰¹æ€§ï¼š**

- **æ ¡å‡†è¯¯å·®è®¡ç®—**ï¼šæ”¯æŒå¤šç§æ ¡å‡†æŒ‡æ ‡
  - `ECE`: Expected Calibration Errorï¼ˆæœŸæœ›æ ¡å‡†è¯¯å·®ï¼‰
  - `MCE`: Maximum Calibration Errorï¼ˆæœ€å¤§æ ¡å‡†è¯¯å·®ï¼‰
  - `Brier Score`: Brier åˆ†æ•°ï¼ˆå¯é€‰ï¼‰
- **å¯é æ€§å›¾**ï¼šå¯è§†åŒ–æ¨¡å‹é¢„æµ‹æ¦‚ç‡ä¸å®é™…å‡†ç¡®ç‡çš„å…³ç³»
  - å¯¹è§’çº¿è¡¨ç¤ºå®Œç¾æ ¡å‡†
  - åç¦»å¯¹è§’çº¿è¡¨ç¤ºè¿‡åº¦è‡ªä¿¡æˆ–æ¬ è‡ªä¿¡
- **åˆ†æ¡¶åˆ†æ**ï¼šæŒ‰é¢„æµ‹æ¦‚ç‡åˆ†æ¡¶ï¼ˆé»˜è®¤ 10 æ¡¶ï¼‰ï¼Œç»Ÿè®¡æ¯ä¸ªæ¡¶çš„æ ¡å‡†è¯¯å·®
- **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒ dev å’Œ test é›†åŒæ—¶åˆ†æ
- **ä»£ç å¤ç”¨**ï¼šå¤ç”¨ Day4 çš„æ¨¡å‹åŠ è½½å’Œæ¨ç†ä»£ç 

**ä½¿ç”¨æ–¹å¼ï¼š**

```bash
# åŸºæœ¬ä½¿ç”¨ï¼ˆä» config.yaml è¯»å–æ‰€æœ‰å‚æ•°ï¼‰
python scripts/calibration_analysis.py

# æŒ‡å®š checkpoint å’Œæ¨¡å‹è·¯å¾„
python scripts/calibration_analysis.py \
    --checkpoint checkpoints/baseline-lora \
    --base-model /mnt/workspace/models/qwen/Qwen3-1___7B

# æŒ‡å®šæ•°æ®æ–‡ä»¶
python scripts/calibration_analysis.py \
    --dev-file dev.jsonl \
    --test-file test.jsonl

# è‡ªå®šä¹‰åˆ†æ¡¶æ•°é‡
python scripts/calibration_analysis.py --n-buckets 20

# è‡ªå®šä¹‰æ‰¹å¤„ç†å¤§å°
python scripts/calibration_analysis.py --batch-size 8

# åªåˆ†ææµ‹è¯•é›†
python scripts/calibration_analysis.py --dev-file "" --test-file test.jsonl

# ä½¿ç”¨ CPUï¼ˆå¦‚æœ GPU ä¸å¯ç”¨ï¼‰
python scripts/calibration_analysis.py --device cpu
```

**è¾“å…¥æ ¼å¼ï¼š**

**ä½ç½®ï¼š** `data/dev.jsonl`, `data/test.jsonl`

**æ ¼å¼ï¼š** JSONLï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰

**å¿…éœ€å­—æ®µï¼š**
- `id`: æ ·æœ¬ ID
- `text`: æ–‡æœ¬å†…å®¹
- `coarse_label`: æ ‡ç­¾ï¼ˆ0=éæ•æ„Ÿ, 1=æ•æ„Ÿï¼‰

**è¾“å‡ºæ ¼å¼ï¼š**

**ä½ç½®ï¼š** `output/reliability_diagram.png`, `output/ece_results.json`, `output/calibration_buckets.csv`ï¼ˆå¯é€‰ï¼‰

**reliability_diagram.png ç»“æ„ï¼š**
- å¯é æ€§å›¾ï¼ˆReliability Diagramï¼‰
  - X è½´ï¼šé¢„æµ‹æ¦‚ç‡ï¼ˆå¹³å‡ç½®ä¿¡åº¦ï¼‰
  - Y è½´ï¼šå®é™…å‡†ç¡®ç‡ï¼ˆè§‚å¯Ÿåˆ°çš„å‡†ç¡®ç‡ï¼‰
  - å¯¹è§’çº¿ï¼šå®Œç¾æ ¡å‡†çº¿
  - æŸ±çŠ¶å›¾ï¼šæ¯ä¸ªæ¡¶çš„æ ·æœ¬æ•°é‡
  - è¯¯å·®æ¡ï¼šæ¯ä¸ªæ¡¶çš„æ ‡å‡†è¯¯å·®ï¼ˆå¯é€‰ï¼‰

**ece_results.json ç»“æ„ï¼š**
```json
{
  "dev": {
    "ece": 0.1234,
    "mce": 0.2345,
    "brier_score": 0.1567,
    "n_samples": 4948,
    "n_buckets": 10
  },
  "test": {
    "ece": 0.1345,
    "mce": 0.2456,
    "brier_score": 0.1678,
    "n_samples": 4948,
    "n_buckets": 10
  },
  "overall": {
    "ece": 0.1289,
    "mce": 0.2401,
    "brier_score": 0.1623,
    "n_samples": 9896,
    "n_buckets": 10
  }
}
```

**calibration_buckets.csv ç»“æ„ï¼ˆå¯é€‰ï¼‰ï¼š**
```csv
bucket_id,prob_min,prob_max,prob_mean,n_samples,n_correct,accuracy,avg_confidence,gap,ece_contribution
0,0.0,0.1,0.05,123,45,0.3659,0.05,0.3159,0.0316
1,0.1,0.2,0.15,234,89,0.3803,0.15,0.2303,0.0230
...
9,0.9,1.0,0.95,4567,4321,0.9461,0.95,0.0039,0.0004
```

**é…ç½®å‚æ•°ï¼ˆconfig.yamlï¼‰ï¼š**

```yaml
# æ¨¡å‹é…ç½®
model:
  name_or_path: "Qwen/Qwen3-1.7B"  # æˆ–æœ¬åœ°è·¯å¾„
  max_length: 512

# è®­ç»ƒé…ç½®ï¼ˆç”¨äºè¯»å– checkpoint è·¯å¾„ï¼‰
training:
  output_dir: "checkpoints/baseline-lora"

# æ ¡å‡†åˆ†æé…ç½®
calibration:
  n_buckets: 10  # åˆ†æ¡¶æ•°é‡
  batch_size: 16  # æ‰¹å¤„ç†å¤§å°
  device: "cuda"  # è®¾å¤‡ï¼ˆcuda/cpuï¼‰
```

**å¢é‡åˆ†æè¯´æ˜ï¼š**

- **æ–° baseline æ¨¡å‹è®­ç»ƒåï¼š**
  - åªéœ€é‡æ–°è¿è¡Œ `calibration_analysis.py` å³å¯è·å¾—æœ€æ–°æ ¡å‡†åˆ†æç»“æœ
  - æ— éœ€ä¿®æ”¹ä»£ç 

- **æ–°æ•°æ®åŠ å…¥åï¼š**
  - é‡æ–°ç”Ÿæˆ `dev.jsonl` å’Œ `test.jsonl`
  - é‡æ–°è¿è¡Œ `calibration_analysis.py` å³å¯

**å·¥ç¨‹/å®¹å™¨åŒ–çº¦å®šï¼š**

- æ‰€æœ‰è·¯å¾„ä» `config.yaml` æˆ– CLI å‚æ•°è¯»å–ï¼š
  - `data_dir`ï¼ˆé»˜è®¤ `./data`ï¼‰
  - `output_dir`ï¼ˆé»˜è®¤ `./output`ï¼‰
  - `checkpoint_path`ï¼ˆä» `training.output_dir` è¯»å–ï¼‰

- æ¨¡å‹è·¯å¾„ï¼š
  - æ”¯æŒ HuggingFace æ¨¡å‹ IDï¼ˆå¦‚ `Qwen/Qwen3-1.7B`ï¼‰
  - æ”¯æŒæœ¬åœ°è·¯å¾„ï¼ˆå¦‚ `/mnt/workspace/models/qwen/Qwen3-1___7B`ï¼‰

- è¾“å‡ºç›®å½•ï¼š
  - ç»Ÿä¸€ä½¿ç”¨ `output/` ç›®å½•
  - æ–¹ä¾¿äº‘ç«¯å’Œæœ¬åœ°ç»Ÿä¸€ä½¿ç”¨

- ä»£ç å¤ç”¨ï¼š
  - å¤ç”¨ `uncertainty_analysis.py` ä¸­çš„æ¨¡å‹åŠ è½½å’Œæ¨ç†å‡½æ•°
  - é¿å…é‡å¤ä»£ç ï¼Œä¿æŒä¸€è‡´æ€§

**åˆ†æç›‘æ§ï¼š**

- åˆ†æè¿‡ç¨‹ä¸­ä¼šè¾“å‡ºï¼š
  - æ¯ 100 ä¸ªæ‰¹æ¬¡çš„å¤„ç†è¿›åº¦
  - æ¨¡å‹é¢„æµ‹è¿›åº¦
  - æ ¡å‡†è¯¯å·®è®¡ç®—è¿›åº¦

- åˆ†æå®Œæˆåä¼šè¾“å‡ºï¼š
  - ECE å’Œ MCE å€¼
  - åˆ†æ¡¶ç»Ÿè®¡æ‘˜è¦
  - è¾“å‡ºæ–‡ä»¶è·¯å¾„

**æ³¨æ„äº‹é¡¹ï¼š**

- **æ ¡å‡†è¯¯å·®è§£é‡Š**ï¼š
  - ECE < 0.05ï¼šæ ¡å‡†è‰¯å¥½
  - 0.05 â‰¤ ECE < 0.15ï¼šæ ¡å‡†å¯æ¥å—
  - ECE â‰¥ 0.15ï¼šæ ¡å‡†è¾ƒå·®ï¼Œéœ€è¦æ ¡å‡†
  - MCE è¡¨ç¤ºæœ€åæƒ…å†µä¸‹çš„æ ¡å‡†è¯¯å·®

- **å¯é æ€§å›¾è§£è¯»**ï¼š
  - æ›²çº¿åœ¨å¯¹è§’çº¿ä¸Šæ–¹ï¼šæ¨¡å‹è¿‡åº¦è‡ªä¿¡ï¼ˆé¢„æµ‹æ¦‚ç‡ > å®é™…å‡†ç¡®ç‡ï¼‰
  - æ›²çº¿åœ¨å¯¹è§’çº¿ä¸‹æ–¹ï¼šæ¨¡å‹æ¬ è‡ªä¿¡ï¼ˆé¢„æµ‹æ¦‚ç‡ < å®é™…å‡†ç¡®ç‡ï¼‰
  - æ›²çº¿æ¥è¿‘å¯¹è§’çº¿ï¼šæ¨¡å‹æ ¡å‡†è‰¯å¥½

- **åˆ†æ¡¶æ–¹å¼**ï¼šç­‰å®½åˆ†æ¡¶ï¼Œå°† [0, 1] ç­‰åˆ†ä¸º n_buckets ä¸ªåŒºé—´

- **å¯è§†åŒ–ä¾èµ–**ï¼šéœ€è¦å®‰è£… matplotlib å’Œ seaborn

- **å†…å­˜ä¼˜åŒ–**ï¼šå¦‚æœæ˜¾å­˜ä¸è¶³ï¼Œå¯ä»¥ï¼š
  - å‡å° `--batch-size`ï¼ˆé»˜è®¤ 16ï¼‰
  - ä½¿ç”¨ `--device cpu`ï¼ˆè¾ƒæ…¢ä½†ä¸éœ€è¦ GPUï¼‰

- **ä¸ Day4 çš„å…³ç³»**ï¼š
  - Day4 åˆ†æä¸ç¡®å®šæ€§ u ä¸é”™è¯¯ç‡çš„ç›¸å…³æ€§
  - Day5 åˆ†æé¢„æµ‹æ¦‚ç‡ p(c|x) ä¸å®é™…å‡†ç¡®ç‡çš„æ ¡å‡†æƒ…å†µ
  - ä¸¤è€…äº’è¡¥ï¼Œå…±åŒä¸º EMG æä¾›ä¾æ®

---

## Day5 å®ç°æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½å®ç°

- [x] **æ¨¡å‹åŠ è½½å’Œæ¨ç†**
  - [x] å¤ç”¨ `uncertainty_analysis.py` ä¸­çš„ `load_baseline_model` å‡½æ•°
  - [x] å¤ç”¨ `uncertainty_analysis.py` ä¸­çš„ `predict_with_baseline` å‡½æ•°
  - [x] ç¡®ä¿é¢„æµ‹ç»“æœåŒ…å« `pred_probs`ï¼ˆé¢„æµ‹æ¦‚ç‡ï¼‰å’Œ `coarse_label`ï¼ˆçœŸå®æ ‡ç­¾ï¼‰

- [x] **æ ¡å‡†è¯¯å·®è®¡ç®—**
  - [x] å®ç° `compute_ece` å‡½æ•°ï¼šè®¡ç®—æœŸæœ›æ ¡å‡†è¯¯å·®
  - [x] å®ç° `compute_mce` å‡½æ•°ï¼šè®¡ç®—æœ€å¤§æ ¡å‡†è¯¯å·®
  - [x] å®ç° `compute_brier_score` å‡½æ•°ï¼šè®¡ç®— Brier åˆ†æ•°ï¼ˆå¯é€‰ï¼‰
  - [x] å®ç° `calibration_buckets` å‡½æ•°ï¼šæŒ‰é¢„æµ‹æ¦‚ç‡åˆ†æ¡¶

- [x] **å¯é æ€§å›¾ç»˜åˆ¶**
  - [x] å®ç° `plot_reliability_diagram` å‡½æ•°
  - [x] ç»˜åˆ¶é¢„æµ‹æ¦‚ç‡ vs å®é™…å‡†ç¡®ç‡
  - [x] æ·»åŠ å®Œç¾æ ¡å‡†å¯¹è§’çº¿
  - [x] æ·»åŠ æ ·æœ¬æ•°é‡æŸ±çŠ¶å›¾
  - [x] æ·»åŠ è¯¯å·®æ¡ï¼ˆå¯é€‰ï¼‰

- [x] **ä¸»å‡½æ•°å®ç°**
  - [x] ä» config.yaml è¯»å–é…ç½®
  - [x] æ”¯æŒå‘½ä»¤è¡Œå‚æ•°
  - [x] å¤„ç† dev å’Œ test é›†
  - [x] ä¿å­˜ç»“æœåˆ°æ–‡ä»¶

### æµ‹è¯•æ–‡ä»¶

- [ ] **test_calibration_analysis.py**
  - [ ] æµ‹è¯•è„šæœ¬åŸºæœ¬åŠŸèƒ½ï¼ˆå¯é€‰ï¼Œæ ¸å¿ƒé€»è¾‘å·²æµ‹è¯•ï¼‰
  - [ ] æµ‹è¯•è¾“å…¥è¾“å‡ºæ ¼å¼
  - [ ] æµ‹è¯•é”™è¯¯å¤„ç†

- [x] **test_calibration_analysis_logic.py**
  - [x] æµ‹è¯• ECE è®¡ç®—é€»è¾‘ï¼ˆä¸ä¾èµ– torchï¼‰
  - [x] æµ‹è¯• MCE è®¡ç®—é€»è¾‘
  - [x] æµ‹è¯•åˆ†æ¡¶é€»è¾‘
  - [x] æµ‹è¯•è¾¹ç•Œæƒ…å†µ

### æ–‡æ¡£å’Œç¤ºä¾‹

- [x] **é…ç½®æ–‡ä»¶æ›´æ–°**
  - [x] åœ¨ config.yaml ä¸­æ·»åŠ  calibration é…ç½®
- [ ] **æ›´æ–° README**ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [x] **æ·»åŠ ä½¿ç”¨ç¤ºä¾‹**ï¼ˆå·²åœ¨Day5.mdä¸­ï¼‰
- [x] **æ·»åŠ ç»“æœè§£è¯»è¯´æ˜**ï¼ˆå·²åœ¨Day5.mdä¸­ï¼‰

---

## æ ¡å‡†åˆ†ææ ¸å¿ƒå…¬å¼

### ECE (Expected Calibration Error)

```
ECE = Î£ (|B_m| / n) * |acc(B_m) - conf(B_m)|
```

å…¶ä¸­ï¼š
- `B_m` æ˜¯ç¬¬ m ä¸ªæ¡¶
- `|B_m|` æ˜¯æ¡¶ m ä¸­çš„æ ·æœ¬æ•°
- `n` æ˜¯æ€»æ ·æœ¬æ•°
- `acc(B_m)` æ˜¯æ¡¶ m ä¸­çš„å®é™…å‡†ç¡®ç‡
- `conf(B_m)` æ˜¯æ¡¶ m ä¸­çš„å¹³å‡é¢„æµ‹æ¦‚ç‡

### MCE (Maximum Calibration Error)

```
MCE = max_m |acc(B_m) - conf(B_m)|
```

### Brier Score

```
Brier Score = (1/n) * Î£ (p_i - y_i)Â²
```

å…¶ä¸­ï¼š
- `p_i` æ˜¯é¢„æµ‹æ¦‚ç‡
- `y_i` æ˜¯çœŸå®æ ‡ç­¾ï¼ˆ0 æˆ– 1ï¼‰

---

## é¢„æœŸè¾“å‡ºç¤ºä¾‹

### ECE ç»“æœè§£è¯»

å‡è®¾è¾“å‡ºï¼š
```json
{
  "dev": {
    "ece": 0.1234,
    "mce": 0.2345,
    "n_samples": 4948
  }
}
```

**è§£è¯»ï¼š**
- ECE = 0.1234ï¼šè¡¨ç¤ºå¹³å‡æ ¡å‡†è¯¯å·®ä¸º 12.34%ï¼Œå±äºå¯æ¥å—èŒƒå›´ï¼ˆ0.05-0.15ï¼‰
- MCE = 0.2345ï¼šè¡¨ç¤ºæœ€åæƒ…å†µä¸‹çš„æ ¡å‡†è¯¯å·®ä¸º 23.45%ï¼Œè¯´æ˜æŸäº›æ¡¶çš„æ ¡å‡†è¾ƒå·®
- å»ºè®®ï¼šå¦‚æœ ECE > 0.15ï¼Œè¯´æ˜æ¨¡å‹å­˜åœ¨æ˜æ˜¾çš„è¿‡åº¦è‡ªä¿¡é—®é¢˜ï¼Œéœ€è¦æ ¡å‡†

### å¯é æ€§å›¾è§£è¯»

- **è¿‡åº¦è‡ªä¿¡**ï¼šæ›²çº¿åœ¨å¯¹è§’çº¿ä¸Šæ–¹ï¼Œè¯´æ˜æ¨¡å‹é¢„æµ‹æ¦‚ç‡é«˜äºå®é™…å‡†ç¡®ç‡
- **æ¬ è‡ªä¿¡**ï¼šæ›²çº¿åœ¨å¯¹è§’çº¿ä¸‹æ–¹ï¼Œè¯´æ˜æ¨¡å‹é¢„æµ‹æ¦‚ç‡ä½äºå®é™…å‡†ç¡®ç‡
- **è‰¯å¥½æ ¡å‡†**ï¼šæ›²çº¿æ¥è¿‘å¯¹è§’çº¿ï¼Œè¯´æ˜æ¨¡å‹é¢„æµ‹æ¦‚ç‡ä¸å®é™…å‡†ç¡®ç‡ä¸€è‡´

---

## ä¸ Day4 çš„å¯¹æ¯”

| ç‰¹æ€§ | Day4ï¼ˆä¸ç¡®å®šæ€§åˆ†æï¼‰ | Day5ï¼ˆæ ¡å‡†åˆ†æï¼‰ |
|------|---------------------|-----------------|
| **åˆ†æç›®æ ‡** | ä¸ç¡®å®šæ€§ u ä¸é”™è¯¯ç‡çš„ç›¸å…³æ€§ | é¢„æµ‹æ¦‚ç‡ p(c\|x) ä¸å®é™…å‡†ç¡®ç‡çš„æ ¡å‡† |
| **è¾“å…¥** | baseline é¢„æµ‹ç»“æœ | baseline é¢„æµ‹ç»“æœ |
| **è¾“å‡º** | u vs error rate å›¾è¡¨ | Reliability Diagram + ECE/MCE |
| **ç”¨é€”** | è¯æ˜ä¸ç¡®å®šæ€§å¯ä»¥æŒ‡å¯¼èåˆæƒé‡ | é‡åŒ–è¿‡åº¦è‡ªä¿¡é—®é¢˜ï¼Œä¸ºæ ¡å‡†æä¾›åŠ¨æœº |
| **å…³ç³»** | äº’è¡¥åˆ†æï¼Œå…±åŒä¸º EMG æä¾›ä¾æ® | äº’è¡¥åˆ†æï¼Œå…±åŒä¸º EMG æä¾›ä¾æ® |

---

**æœ€åæ›´æ–°**ï¼š2025-12-12  
**çŠ¶æ€**ï¼šğŸ“ å¾…å®ç°

