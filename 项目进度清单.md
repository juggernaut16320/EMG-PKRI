# 项目进度清单

**最后更新**：2025-12-14

---

## ✅ 已完成任务

### Day1: 数据准备
- [x] TXT 转 JSONL 脚本 (txt_to_jsonl.py)
- [x] 数据清洗脚本 (data_cleaner.py)
- [x] 主标签标注脚本 (coarse_label.py)
- [x] 子标签标注脚本 (subtype_assign.py)
- [x] 数据集划分脚本 (dataset_split.py)
- [x] 困难集构建脚本 (hardset_maker.py)
- [x] 生成完整数据集（train: 39,583, dev: 4,948, test: 4,948）

### Day2: Baseline 训练
- [x] Baseline 训练脚本 (baseline_train.py)
- [x] 使用 Qwen-1.7B + LoRA 微调
- [x] 验证集 F1: 88.3%
- [x] 保存模型 checkpoint

### Day3: Baseline 评估
- [x] Baseline 评估脚本 (eval_baseline.py)
- [x] 测试集 F1: 89.13%
- [x] 高置信错误样本分析
- [x] 生成完整评估报告

### Day4: 不确定性分析
- [x] 不确定性分析脚本 (uncertainty_analysis.py)
- [x] 不确定性 u 与错误率相关性分析
- [x] 相关系数: 0.8379（强正相关）
- [x] 不确定性分桶分析
- [x] 生成 uncertainty 文件

### Day5: 校准分析
- [x] 校准分析脚本 (calibration_analysis.py)
- [x] ECE/MCE 计算逻辑
- [x] 单元测试通过
- [ ] ⚠️ 实际运行（脚本已完成，待运行）

### Day6: 知识后验构建
- [x] 词表生成脚本 (lexicon_generator.py)
- [x] 知识后验构建脚本 (q0_builder.py)
- [x] 生成 q₀ 文件（train/dev/test）
- [x] 参数调整和优化

### Day7: EMG α 搜索
- [x] α 搜索脚本 (emg_bucket_search.py)
- [x] 分桶搜索最优 α*
- [x] 生成 bucket_alpha_star.csv
- [x] 结果符合理论预期

### Day8: PAV 拟合
- [x] PAV 拟合脚本 (emg_fit_alpha_u.py)
- [x] 保序回归算法实现
- [x] 生成 α(u) 查表（100 个点）
- [x] 生成可视化曲线图
- [x] 单调递减性验证

### Day9: EMG 效果验证与门控优化
- [x] EMG 评估脚本 (eval_emg.py)
- [x] 三种方法对比（Baseline、固定α、EMG）
- [x] 完整指标计算（F1、NLL、ECE）
- [x] 生成对比分析和图表
- [x] q₀ 参数调整和验证
- [x] 改进效果验证
- [ ] **知识阈值门控优化**（进行中）
  - 在验证集上搜索最优知识阈值（而非硬编码）
  - 当 `max(q₀) < threshold` 时设置 α=1.0（完全信任模型）
- [ ] **一致性门控**（待实施）
  - 仅当 `argmax(p) == argmax(q₀)` 时允许 α(u) 生效
  - 否则强制 α=0，减少 q₀ 带偏导致的 F1 损失

### 代码质量
- [x] 所有核心脚本实现完成
- [x] 单元测试覆盖主要逻辑
- [x] 代码注释和文档完整
- [x] 支持云端和本地运行

---

## ⚠️ 待完成任务（按优先级排序）

### 🟢 P2：可选优化

### 🟢 P2：可选优化
- [ ] **运行 Day5 校准分析**（可选，1小时）
- [ ] **进一步优化 q₀ 质量**（词表清洗、验证 Precision/Recall）
- [ ] **不确定性指标对比**（u_max vs u_entropy vs u_margin）
  - 考虑 p 和 q₀ 的置信度差异（需要训练）
  - 非线性融合策略（需要训练）
  - 会增加工作量且不一定能救回 F1

### 🔵 长期扩展（根据需求）
- [ ] **Day10-Day12 相关任务**（根据需求）
- [ ] **边缘部署优化**（根据需求）
- [ ] **PKRI 模块实现**（根据需求）

---

## 📊 关键指标总结

| 指标 | 值 | 来源 |
|------|-----|------|
| Baseline F1 | 89.13% | Day3 |
| 不确定性相关系数 | 0.8379 | Day4 |
| EMG NLL 改善 | -2.72% | Day9 |
| EMG ECE 改善 | -11.16% | Day9 |
| EMG F1 变化 | -1.11% | Day9 |

---

**状态**：✅ 核心功能已完成，正在进行优化改进

