### Day7 è¦å®Œæˆçš„ä»£ç ï¼ˆEMG åˆ†æ¡¶ Î± æœç´¢ï¼‰

> **ç¯å¢ƒå‡†å¤‡**ï¼šå¼€å§‹å‰è¯·ç¡®ä¿å·²æ¿€æ´» conda ç¯å¢ƒï¼š`conda activate emgpkri`ï¼ˆæˆ–æ¿€æ´» venvï¼š`source venv/bin/activate`ï¼‰

```text
project/
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ dev.jsonl
â”‚   â”œâ”€â”€ q0_dev.jsonl          # Day6 è¾“å‡º
â”‚
â”œâ”€â”€ output/
â”‚   â”œâ”€â”€ uncertainty_buckets.csv  # Day4 è¾“å‡º
â”‚   â”œâ”€â”€ bucket_alpha_star.csv    # è¾“å‡º
â”‚
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.yaml
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ emg_bucket_search.py
â”‚
â””â”€â”€ requirements.txt
```

### `emg_bucket_search.py`ï¼ˆEMG åˆ†æ¡¶ Î± æœç´¢å·¥å…·ï¼‰

**åŠŸèƒ½ï¼š**
- å¯¹æ¯ä¸ªä¸ç¡®å®šæ€§ u bucketï¼Œæšä¸¾ä¸åŒçš„èåˆæƒé‡ Î±
- åœ¨ dev é›†ä¸Šè®¡ç®— NLL / F1ï¼Œé€‰å‡ºæ¯ä¸ª bucket çš„æœ€ä¼˜ Î±*
- ä¸º Day8 çš„ PAV ä¿åºå›å½’æä¾›æ•°æ®

**å…³é”®ç‰¹æ€§ï¼š**

- **EMG èåˆå…¬å¼**ï¼š
  ```
  p_emg(c|x) = Î± Ã— p(c|x) + (1 - Î±) Ã— q(c|z)
  ```
  å…¶ä¸­ï¼š
  - `p(c|x)`: baseline çš„é¢„æµ‹æ¦‚ç‡
  - `q(c|z)`: qâ‚€ çš„çŸ¥è¯†åéªŒ
  - `Î±`: èåˆæƒé‡ï¼Œåœ¨ [0, 1] ä¹‹é—´
  - `Î±` è¶Šå¤§ï¼Œè¶Šä¿¡ä»»æ¨¡å‹ï¼›`Î±` è¶Šå°ï¼Œè¶Šä¿¡ä»»çŸ¥è¯†

- **åˆ†æ¡¶æœç´¢**ï¼šå¯¹æ¯ä¸ª u bucketï¼Œæšä¸¾ Î± âˆˆ {0, 0.25, 0.5, 0.75, 1}
- **æŒ‡æ ‡è®¡ç®—**ï¼šè®¡ç®— NLLï¼ˆè´Ÿå¯¹æ•°ä¼¼ç„¶ï¼‰å’Œ F1 åˆ†æ•°
- **æœ€ä¼˜é€‰æ‹©**ï¼šä¸ºæ¯ä¸ª bucket é€‰æ‹©ä½¿ F1 æœ€å¤§ï¼ˆæˆ– NLL æœ€å°ï¼‰çš„ Î±*

**ä½¿ç”¨æ–¹å¼ï¼š**

```bash
# åŸºæœ¬ä½¿ç”¨ï¼ˆä» config.yaml è¯»å–æ‰€æœ‰å‚æ•°ï¼‰
python scripts/emg_bucket_search.py

# æŒ‡å®šè¾“å…¥æ–‡ä»¶ï¼ˆä½¿ç”¨ uncertainty_analysis.py çš„è¾“å‡ºï¼‰
python scripts/emg_bucket_search.py \
    --dev-file output/dev_with_uncertainty.jsonl \
    --q0-file data/q0_dev.jsonl \
    --uncertainty-file output/uncertainty_buckets.csv

# æˆ–è€…å¦‚æœ dev.jsonl å·²ç»åŒ…å« pred_probs å’Œ uncertainty
python scripts/emg_bucket_search.py \
    --dev-file data/dev.jsonl \
    --q0-file data/q0_dev.jsonl \
    --uncertainty-file output/uncertainty_buckets.csv

# è‡ªå®šä¹‰ Î± ç½‘æ ¼
python scripts/emg_bucket_search.py \
    --alpha-grid 0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 1.0

# æŒ‡å®šä¼˜åŒ–æŒ‡æ ‡
python scripts/emg_bucket_search.py --metric f1  # æˆ– nll

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶
python scripts/emg_bucket_search.py \
    --output-file output/bucket_alpha_star.csv
```

**è¾“å…¥æ ¼å¼ï¼š**

**ä½ç½®ï¼š** 
- `output/dev_with_uncertainty.jsonl` - dev é›†æ•°æ®ï¼ˆåŒ…å« baseline é¢„æµ‹ç»“æœå’Œ uncertaintyï¼ŒDay4 è¾“å‡ºï¼‰
- `data/q0_dev.jsonl` - qâ‚€ åéªŒï¼ˆDay6 è¾“å‡ºï¼‰
- `output/uncertainty_buckets.csv` - ä¸ç¡®å®šæ€§åˆ†æ¡¶ç»“æœï¼ˆDay4 è¾“å‡ºï¼‰

**æ³¨æ„ï¼š** 
- å¦‚æœ `dev.jsonl` å·²ç»åŒ…å« `pred_probs` å’Œ `uncertainty` å­—æ®µï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
- å¦åˆ™ï¼Œè¯·å…ˆè¿è¡Œ `uncertainty_analysis.py`ï¼Œå®ƒä¼šç”Ÿæˆ `output/dev_with_uncertainty.jsonl`

**dev_with_uncertainty.jsonl æ ¼å¼ï¼š**
```json
{
  "id": "s1898",
  "text": "æ–‡æœ¬å†…å®¹",
  "coarse_label": 1,
  "pred_label": 1,
  "pred_prob": 0.8,
  "pred_probs": [0.2, 0.8],  // baseline é¢„æµ‹æ¦‚ç‡
  "uncertainty": 0.15,       // ä¸ç¡®å®šæ€§ u
  "max_prob": 0.85
}
```

**q0_dev.jsonl æ ¼å¼ï¼š**
```json
{
  "id": "s1898",
  "text": "æ–‡æœ¬å†…å®¹",
  "q0": [0.1, 0.9]  // qâ‚€ çŸ¥è¯†åéªŒ
}
```

**uncertainty_buckets.csv æ ¼å¼ï¼š**
```csv
bucket_id,u_min,u_max,u_mean,n_samples,error_rate
0,0.0,0.1,0.05,7825,0.0856
1,0.1,0.2,0.15,758,0.3364
...
```

**è¾“å‡ºæ ¼å¼ï¼š**

**ä½ç½®ï¼š** `output/bucket_alpha_star.csv`

**æ ¼å¼ï¼š**
```csv
bucket_id,u_min,u_max,u_mean,n_samples,alpha_star,f1_at_alpha_star,nll_at_alpha_star,alpha_0_f1,alpha_0_nll,alpha_0_25_f1,alpha_0_25_nll,alpha_0_5_f1,alpha_0_5_nll,alpha_0_75_f1,alpha_0_75_nll,alpha_1_f1,alpha_1_nll
0,0.0,0.1,0.05,7825,0.75,0.9123,0.2345,0.8901,0.2567,0.9012,0.2456,0.9089,0.2389,0.9123,0.2345,0.9105,0.2367
1,0.1,0.2,0.15,758,0.5,0.8234,0.3456,0.7890,0.3789,0.8012,0.3567,0.8234,0.3456,0.8156,0.3523,0.8123,0.3545
...
```

**å­—æ®µè¯´æ˜ï¼š**
- `bucket_id`: æ¡¶ ID
- `u_min`, `u_max`, `u_mean`: ä¸ç¡®å®šæ€§èŒƒå›´
- `n_samples`: æ¡¶å†…æ ·æœ¬æ•°
- `alpha_star`: æœ€ä¼˜ Î± å€¼
- `f1_at_alpha_star`: æœ€ä¼˜ Î± ä¸‹çš„ F1 åˆ†æ•°
- `nll_at_alpha_star`: æœ€ä¼˜ Î± ä¸‹çš„ NLL
- `alpha_X_f1`, `alpha_X_nll`: å„ä¸ª Î± å€¼ä¸‹çš„ F1 å’Œ NLL

**é…ç½®å‚æ•°ï¼ˆconfig.yamlï¼‰ï¼š**

```yaml
# EMG åˆ†æ¡¶ Î± æœç´¢é…ç½®ï¼ˆDay7ï¼‰
emg_bucket_search:
  alpha_grid: [0, 0.25, 0.5, 0.75, 1.0]  # Î± ç½‘æ ¼
  metric: "f1"  # ä¼˜åŒ–æŒ‡æ ‡ï¼šf1 æˆ– nll
  bucket_type: "equal_width"  # åˆ†æ¡¶ç±»å‹ï¼šequal_width æˆ– equal_freqï¼ˆé¢„ç•™ï¼‰
```

**å¢é‡åˆ†æè¯´æ˜ï¼š**

- **baseline æˆ– qâ‚€ æ›´æ–°åï¼š**
  - é‡æ–°è¿è¡Œ `emg_bucket_search.py` å³å¯è·å¾—æ–°çš„ Î±*
  - æ— éœ€ä¿®æ”¹ä»£ç 

- **æ–°æ•°æ®åŠ å…¥åï¼š**
  - é‡æ–°ç”Ÿæˆ dev é›†å’Œ qâ‚€ åéªŒ
  - é‡æ–°è¿è¡Œæœ¬è„šæœ¬

**å·¥ç¨‹/å®¹å™¨åŒ–çº¦å®šï¼š**

- æ‰€æœ‰è·¯å¾„ä» `config.yaml` æˆ– CLI å‚æ•°è¯»å–ï¼š
  - `data_dir`ï¼ˆé»˜è®¤ `./data`ï¼‰
  - `output_dir`ï¼ˆé»˜è®¤ `./output`ï¼‰

- æ”¯æŒå¤šç§è¾“å…¥æ ¼å¼ï¼ˆJSONLã€CSVï¼‰
- è¾“å‡ºç»Ÿä¸€çš„ CSV æ ¼å¼ï¼Œæ–¹ä¾¿åç»­å¤„ç†

**åˆ†æç›‘æ§ï¼š**

- å¤„ç†è¿‡ç¨‹ä¸­ä¼šè¾“å‡ºï¼š
  - æ¯ä¸ª bucket çš„å¤„ç†è¿›åº¦
  - æ¯ä¸ª Î± å€¼çš„æŒ‡æ ‡è®¡ç®—è¿›åº¦
  - æœ€ä¼˜ Î±* çš„é€‰æ‹©ç»“æœ

- å¤„ç†å®Œæˆåä¼šè¾“å‡ºï¼š
  - æ¯ä¸ª bucket çš„æœ€ä¼˜ Î±* å’Œå¯¹åº”æŒ‡æ ‡
  - æ€»ä½“ç»Ÿè®¡ä¿¡æ¯
  - è¾“å‡ºæ–‡ä»¶è·¯å¾„

**æ³¨æ„äº‹é¡¹ï¼š**

- **èåˆå…¬å¼**ï¼š
  - Î± = 0ï¼šå®Œå…¨ä¿¡ä»»çŸ¥è¯† qâ‚€
  - Î± = 1ï¼šå®Œå…¨ä¿¡ä»»æ¨¡å‹ p(c|x)
  - Î± = 0.5ï¼šå¹³å‡èåˆ

- **ä¼˜åŒ–æŒ‡æ ‡é€‰æ‹©**ï¼š
  - F1ï¼šå…³æ³¨åˆ†ç±»æ€§èƒ½ï¼ˆæ¨èï¼‰
  - NLLï¼šå…³æ³¨æ¦‚ç‡æ ¡å‡†

- **åˆ†æ¡¶ç­–ç•¥**ï¼š
  - ä½¿ç”¨ Day4 çš„ä¸ç¡®å®šæ€§åˆ†æ¡¶ç»“æœ
  - æ¯ä¸ª bucket ç‹¬ç«‹æœç´¢æœ€ä¼˜ Î±

- **ä¸ Day8 çš„å…³ç³»ï¼š**
  - Day7 è¾“å‡ºç¦»æ•£çš„ Î±*ï¼Œä¸ºæ¯ä¸ª bucket æ‰¾åˆ°æœ€ä¼˜å€¼
  - Day8 ä½¿ç”¨ PAV ä¿åºå›å½’æ‹Ÿåˆè¿ç»­çš„ Î±(u) å‡½æ•°
  - ç¡®ä¿ Î±(u) æ˜¯å•è°ƒé€’å¢çš„ï¼ˆä¸ç¡®å®šæ€§è¶Šé«˜ï¼Œè¶Šä¿¡ä»»çŸ¥è¯†ï¼‰

---

## Day7 å®ç°æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½å®ç°

- [ ] **emg_bucket_search.py**
  - [ ] åŠ è½½ baseline é¢„æµ‹ç»“æœï¼ˆä» uncertainty_analysis è¾“å‡ºæˆ–å•ç‹¬åŠ è½½ï¼‰
  - [ ] åŠ è½½ qâ‚€ åéªŒ
  - [ ] åŠ è½½ä¸ç¡®å®šæ€§åˆ†æ¡¶ä¿¡æ¯
  - [ ] EMG èåˆè®¡ç®—
  - [ ] Î± ç½‘æ ¼æœç´¢
  - [ ] F1/NLL è®¡ç®—
  - [ ] æœ€ä¼˜ Î±* é€‰æ‹©
  - [ ] ç»“æœè¾“å‡º

### æµ‹è¯•æ–‡ä»¶

- [ ] **test_emg_bucket_search.py**
  - [ ] æµ‹è¯•è„šæœ¬åŸºæœ¬åŠŸèƒ½
  - [ ] æµ‹è¯•è¾“å…¥è¾“å‡ºæ ¼å¼
  - [ ] æµ‹è¯•é”™è¯¯å¤„ç†

- [ ] **test_emg_bucket_search_logic.py**
  - [ ] æµ‹è¯• EMG èåˆé€»è¾‘
  - [ ] æµ‹è¯• Î± æœç´¢é€»è¾‘
  - [ ] æµ‹è¯•è¾¹ç•Œæƒ…å†µ

### æ–‡æ¡£å’Œç¤ºä¾‹

- [x] **Day7.md æ–‡æ¡£**ï¼ˆå½“å‰æ–‡æ¡£ï¼‰
- [ ] **é…ç½®æ–‡ä»¶æ›´æ–°**
  - [ ] åœ¨ config.yaml ä¸­æ·»åŠ  emg_bucket_search é…ç½®

---

## EMG èåˆæ ¸å¿ƒå…¬å¼

### åŸºç¡€èåˆå…¬å¼

```
p_emg(c|x) = Î± Ã— p(c|x) + (1 - Î±) Ã— q(c|z)
```

å…¶ä¸­ï¼š
- `p(c|x)`: baseline é¢„æµ‹æ¦‚ç‡ [p_non_sensitive, p_sensitive]
- `q(c|z)`: qâ‚€ çŸ¥è¯†åéªŒ [p_non_sensitive, p_sensitive]
- `Î±`: èåˆæƒé‡ï¼ŒÎ± âˆˆ [0, 1]

### åˆ†æ¡¶æœç´¢ç­–ç•¥

```
å¯¹æ¯ä¸ª u bucket:
  å¯¹æ¯ä¸ª Î± âˆˆ {0, 0.25, 0.5, 0.75, 1}:
    è®¡ç®— p_emg = Î± Ã— p + (1 - Î±) Ã— q
    è®¡ç®— F1 å’Œ NLL
  é€‰æ‹©ä½¿ F1 æœ€å¤§ï¼ˆæˆ– NLL æœ€å°ï¼‰çš„ Î± ä½œä¸º Î±*
```

### æŒ‡æ ‡è®¡ç®—

**F1 åˆ†æ•°ï¼š**
```
F1 = 2 Ã— (precision Ã— recall) / (precision + recall)
```

**NLLï¼ˆè´Ÿå¯¹æ•°ä¼¼ç„¶ï¼‰ï¼š**
```
NLL = -Î£ log(p_emg(c_true|x))
```

---

## é¢„æœŸè¾“å‡ºç¤ºä¾‹

### æœ€ä¼˜ Î±* ç»Ÿè®¡

å‡è®¾è¾“å‡ºï¼š
```csv
bucket_id,alpha_star,f1_at_alpha_star
0,0.75,0.9123
1,0.5,0.8234
2,0.25,0.7567
...
```

**è§£è¯»ï¼š**
- ä½ä¸ç¡®å®šæ€§ bucketï¼ˆbucket 0ï¼‰ï¼šÎ±* = 0.75ï¼Œæ›´ä¿¡ä»»æ¨¡å‹
- é«˜ä¸ç¡®å®šæ€§ bucketï¼ˆbucket 2ï¼‰ï¼šÎ±* = 0.25ï¼Œæ›´ä¿¡ä»»çŸ¥è¯†
- ç¬¦åˆé¢„æœŸï¼šä¸ç¡®å®šæ€§è¶Šé«˜ï¼Œè¶Šä¿¡ä»»çŸ¥è¯†

---

## ä¸ Day6 çš„å¯¹æ¯”

| ç‰¹æ€§ | Day6ï¼ˆçŸ¥è¯†åéªŒæ„å»ºï¼‰ | Day7ï¼ˆEMG Î± æœç´¢ï¼‰ |
|------|---------------------|-------------------|
| **ç›®æ ‡** | æ„å»ºçŸ¥è¯†åéªŒ qâ‚€ | æ‰¾åˆ°æœ€ä¼˜èåˆæƒé‡ Î± |
| **è¾“å…¥** | åŸå§‹æ–‡æœ¬ + è¯è¡¨ | p(c\|x) + qâ‚€ + u åˆ†æ¡¶ |
| **è¾“å‡º** | qâ‚€ åéªŒæ¦‚ç‡ | æœ€ä¼˜ Î±* å€¼ |
| **ç”¨é€”** | ä¸º EMG æä¾›çŸ¥è¯†é€šé“ | ä¸º EMG æä¾›èåˆæƒé‡ |
| **å…³ç³»** | æ„å»ºçŸ¥è¯†ä¿¡å· | ç¡®å®šå¦‚ä½•èåˆæ¨¡å‹å’ŒçŸ¥è¯† |

---

**æœ€åæ›´æ–°**ï¼š2025-12-13  
**çŠ¶æ€**ï¼šğŸ“ å¾…å®ç°

