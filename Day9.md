### Day9 è¦å®Œæˆçš„ä»£ç ï¼ˆEMG æ•ˆæžœéªŒè¯ï¼‰

> **çŽ¯å¢ƒå‡†å¤‡**ï¼šå¼€å§‹å‰è¯·ç¡®ä¿å·²æ¿€æ´» conda çŽ¯å¢ƒï¼š`conda activate emgpkri`ï¼ˆæˆ–æ¿€æ´» venvï¼š`source venv/bin/activate`ï¼‰

```text
project/
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ test.jsonl
â”‚   â”œâ”€â”€ hard_eval_set.jsonl          # å¯é€‰
â”‚   â”œâ”€â”€ q0_test.jsonl                # Day6 è¾“å‡º
â”‚
â”œâ”€â”€ output/
â”‚   â”œâ”€â”€ test_with_uncertainty.jsonl  # Day4 è¾“å‡ºï¼ˆåŒ…å« baseline é¢„æµ‹å’Œ uncertaintyï¼‰
â”‚   â”œâ”€â”€ alpha_u_lut.json             # Day8 è¾“å‡ºï¼ˆÎ±(u) æŸ¥è¡¨ï¼‰
â”‚   â”œâ”€â”€ metrics_emg.json             # è¾“å‡ºï¼šè¯„ä¼°æŒ‡æ ‡
â”‚   â”œâ”€â”€ emg_comparison_table.csv     # è¾“å‡ºï¼šå¯¹æ¯”è¡¨æ ¼
â”‚   â””â”€â”€ emg_comparison_charts.png    # è¾“å‡ºï¼šå¯¹æ¯”å›¾è¡¨
â”‚
â”œâ”€â”€ configs/
â”‚   â””â”€â”€ config.yaml
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ eval_emg.py
â”‚
â””â”€â”€ requirements.txt
```

### `eval_emg.py`ï¼ˆEMG æ•ˆæžœéªŒè¯å·¥å…·ï¼‰

**åŠŸèƒ½ï¼š**
- åœ¨ test å’Œ hardset ä¸Šå¯¹æ¯”ä¸‰ç§æ–¹æ³•ï¼š
  1. **Baseline**ï¼šåªä½¿ç”¨æ¨¡åž‹é¢„æµ‹ p(c|x)
  2. **å›ºå®š Î± èžåˆ**ï¼šä½¿ç”¨å›ºå®šçš„ Î± å€¼è¿›è¡Œèžåˆ
  3. **EMG**ï¼šä½¿ç”¨ä¸ç¡®å®šæ€§è‡ªé€‚åº”çš„ Î±(u) è¿›è¡Œèžåˆ
- è®¡ç®—å¹¶å¯¹æ¯”å„ç§æŒ‡æ ‡ï¼šAccuracyã€F1ã€Precisionã€Recallã€NLLã€ECE ç­‰
- ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼å’Œå¯è§†åŒ–å›¾è¡¨

**å…³é”®ç‰¹æ€§ï¼š**

- **EMG èžåˆå…¬å¼**ï¼š
  ```
  p_emg(c|x) = Î±(u) Ã— p(c|x) + (1 - Î±(u)) Ã— qâ‚€(c|z)
  ```
  å…¶ä¸­ï¼š
  - `p(c|x)`: baseline çš„é¢„æµ‹æ¦‚çŽ‡
  - `qâ‚€(c|z)`: çŸ¥è¯†åŽéªŒï¼ˆDay6 è¾“å‡ºï¼‰
  - `Î±(u)`: ä¸ç¡®å®šæ€§è‡ªé€‚åº”çš„èžåˆæƒé‡ï¼ˆDay8 è¾“å‡ºçš„ Î±(u) æŸ¥è¡¨ï¼‰
  - `u`: ä¸ç¡®å®šæ€§æŒ‡æ ‡ u = 1 - max_c p(c|x)

- **ä¸‰ç§æ–¹æ³•å¯¹æ¯”**ï¼š
  - **Baseline**ï¼šç›´æŽ¥ä½¿ç”¨ p(c|x)ï¼Œæ— éœ€èžåˆ
  - **å›ºå®š Î± èžåˆ**ï¼šä½¿ç”¨å›ºå®šçš„ Î± å€¼ï¼ˆå¦‚ 0.5ï¼‰ï¼Œä¸ä¾èµ–ä¸ç¡®å®šæ€§
  - **EMG**ï¼šæ ¹æ®ä¸ç¡®å®šæ€§ u åŠ¨æ€æŸ¥æ‰¾ Î±(u)ï¼Œå®žçŽ°è‡ªé€‚åº”èžåˆ

- **è¯„ä¼°æŒ‡æ ‡**ï¼š
  - åˆ†ç±»æŒ‡æ ‡ï¼šAccuracyã€F1ã€Precisionã€Recall
  - æ¦‚çŽ‡æŒ‡æ ‡ï¼šNLLï¼ˆè´Ÿå¯¹æ•°ä¼¼ç„¶ï¼‰ã€ECEï¼ˆæœŸæœ›æ ¡å‡†è¯¯å·®ï¼‰
  - å¯¹æ¯”åˆ†æžï¼šä¸‰ç§æ–¹æ³•çš„æ€§èƒ½å¯¹æ¯”ã€æ”¹è¿›å¹…åº¦åˆ†æž

---

## å®žçŽ°æ–¹æ¡ˆ

**æ ¸å¿ƒæ€è·¯**ï¼š
- ç›´æŽ¥åŠ è½½å·²æœ‰æ•°æ®æ–‡ä»¶ï¼ˆbaseline é¢„æµ‹ã€qâ‚€ã€Î±(u) æŸ¥è¡¨ï¼‰
- ä½¿ç”¨çº¿æ€§æ’å€¼æŸ¥æ‰¾ Î±(u)
- å¤ç”¨ Day7 çš„ `compute_emg_fusion` å‡½æ•°
- ä½¿ç”¨ sklearn è®¡ç®—è¯„ä¼°æŒ‡æ ‡

**å®žçŽ°è¦ç‚¹**ï¼š
1. **æ•°æ®åŠ è½½**ï¼š
   - ä»Ž `test_with_uncertainty.jsonl` åŠ è½½ baseline é¢„æµ‹ç»“æžœå’Œ uncertainty
   - ä»Ž `q0_test.jsonl` åŠ è½½ qâ‚€ åŽéªŒ
   - ä»Ž `alpha_u_lut.json` åŠ è½½ Î±(u) æŸ¥è¡¨

2. **Î±(u) æŸ¥æ‰¾**ï¼š
   ```python
   def lookup_alpha(u: float, lut: Dict) -> float:
       """çº¿æ€§æ’å€¼æŸ¥æ‰¾ Î±(u)"""
       u_list = lut['u']
       alpha_list = lut['alpha']
       return np.interp(u, u_list, alpha_list)
   ```

3. **èžåˆè®¡ç®—**ï¼š
   - å¤ç”¨ `compute_emg_fusion` å‡½æ•°
   - å¯¹æ¯ä¸ªæ ·æœ¬ï¼šè®¡ç®— u â†’ æŸ¥æ‰¾ Î±(u) â†’ è®¡ç®— p_emg

4. **æŒ‡æ ‡è®¡ç®—**ï¼š
   - ä½¿ç”¨ sklearn.metrics è®¡ç®—æ‰€æœ‰æŒ‡æ ‡
   - å¯¹æ¯”ä¸‰ç§æ–¹æ³•çš„æ€§èƒ½

---

## è¾“å…¥æ ¼å¼

### 1. Baseline é¢„æµ‹ç»“æžœæ–‡ä»¶

**ä½ç½®ï¼š** `output/test_with_uncertainty.jsonl`ï¼ˆDay4 è¾“å‡ºï¼‰

**æ ¼å¼ï¼š**
```json
{
  "id": "s1234",
  "text": "æ–‡æœ¬å†…å®¹",
  "coarse_label": 1,
  "pred_label": 1,
  "pred_prob": 0.85,
  "pred_probs": [0.15, 0.85],
  "uncertainty": 0.15,
  "max_prob": 0.85
}
```

**å¿…éœ€å­—æ®µ**ï¼š
- `id`: æ ·æœ¬ ID
- `coarse_label`: çœŸå®žæ ‡ç­¾ï¼ˆ0 æˆ– 1ï¼‰
- `pred_probs`: baseline é¢„æµ‹æ¦‚çŽ‡ [p_non_sensitive, p_sensitive]
- `uncertainty`: ä¸ç¡®å®šæ€§æŒ‡æ ‡ u

### 2. qâ‚€ åŽéªŒæ–‡ä»¶

**ä½ç½®ï¼š** `data/q0_test.jsonl`ï¼ˆDay6 è¾“å‡ºï¼‰

**æ ¼å¼ï¼š**
```json
{
  "id": "s1234",
  "text": "æ–‡æœ¬å†…å®¹",
  "q0": [0.2, 0.8]
}
```

**å¿…éœ€å­—æ®µ**ï¼š
- `id`: æ ·æœ¬ IDï¼ˆéœ€è¦ä¸Ž baseline æ–‡ä»¶ä¸­çš„ ID åŒ¹é…ï¼‰
- `q0`: qâ‚€ åŽéªŒæ¦‚çŽ‡ [p_non_sensitive, p_sensitive]

### 3. Î±(u) æŸ¥è¡¨æ–‡ä»¶

**ä½ç½®ï¼š** `output/alpha_u_lut.json`ï¼ˆDay8 è¾“å‡ºï¼‰

**æ ¼å¼ï¼š**
```json
{
  "u": [0.0156, 0.0200, 0.0244, ...],
  "alpha": [0.7500, 0.7374, 0.7247, ...]
}
```

**å¿…éœ€å­—æ®µ**ï¼š
- `u`: u å€¼åˆ—è¡¨ï¼ˆå·²æŽ’åºï¼Œå•è°ƒé€’å¢žï¼‰
- `alpha`: å¯¹åº”çš„ Î± å€¼åˆ—è¡¨ï¼ˆå·²æŽ’åºï¼Œå•è°ƒé€’å‡ï¼‰

---

## è¾“å‡ºæ ¼å¼

### 1. è¯„ä¼°æŒ‡æ ‡æ–‡ä»¶

**ä½ç½®ï¼š** `output/metrics_emg.json`

**æ ¼å¼ï¼š**
```json
{
  "test_set": {
    "baseline": {
      "accuracy": 0.8595,
      "f1": 0.8913,
      "precision": 0.8942,
      "recall": 0.8883,
      "nll": 0.4523,
      "ece": 0.1234
    },
    "fixed_alpha_0.5": {
      "accuracy": 0.8650,
      "f1": 0.8956,
      "precision": 0.8989,
      "recall": 0.8923,
      "nll": 0.4389,
      "ece": 0.1123
    },
    "emg": {
      "accuracy": 0.8720,
      "f1": 0.9023,
      "precision": 0.9056,
      "recall": 0.8990,
      "nll": 0.4234,
      "ece": 0.0987
    }
  },
  "hard_set": {
    "baseline": {...},
    "fixed_alpha_0.5": {...},
    "emg": {...}
  },
  "comparison": {
    "emg_vs_baseline": {
      "f1_improvement": 0.0110,
      "f1_improvement_percent": 1.23,
      "nll_reduction": 0.0289,
      "nll_reduction_percent": 6.39
    },
    "emg_vs_fixed_alpha": {
      "f1_improvement": 0.0067,
      "f1_improvement_percent": 0.75,
      "nll_reduction": 0.0155,
      "nll_reduction_percent": 3.53
    }
  }
}
```

### 2. å¯¹æ¯”è¡¨æ ¼æ–‡ä»¶

**ä½ç½®ï¼š** `output/emg_comparison_table.csv`

**æ ¼å¼ï¼š**
```csv
method,dataset,accuracy,f1,precision,recall,nll,ece
baseline,test,0.8595,0.8913,0.8942,0.8883,0.4523,0.1234
fixed_alpha_0.5,test,0.8650,0.8956,0.8989,0.8923,0.4389,0.1123
emg,test,0.8720,0.9023,0.9056,0.8990,0.4234,0.0987
baseline,hard,0.6234,0.7123,0.7234,0.7012,0.6789,0.2345
fixed_alpha_0.5,hard,0.6456,0.7234,0.7345,0.7123,0.6543,0.2123
emg,hard,0.6789,0.7456,0.7567,0.7345,0.6234,0.1890
```

### 3. å¯¹æ¯”å›¾è¡¨æ–‡ä»¶

**ä½ç½®ï¼š** `output/emg_comparison_charts.png`

**å†…å®¹**ï¼š
- ä¸‰ç§æ–¹æ³•åœ¨ test å’Œ hard é›†ä¸Šçš„ F1 å¯¹æ¯”ï¼ˆæŸ±çŠ¶å›¾ï¼‰
- ä¸‰ç§æ–¹æ³•çš„ NLL å¯¹æ¯”ï¼ˆæŸ±çŠ¶å›¾ï¼‰
- ä¸‰ç§æ–¹æ³•çš„ ECE å¯¹æ¯”ï¼ˆæŸ±çŠ¶å›¾ï¼‰
- æ€§èƒ½æå‡å¹…åº¦ï¼ˆEMG vs Baselineï¼ŒEMG vs Fixed Alphaï¼‰

---

## ä½¿ç”¨æ–¹å¼

```bash
# åŸºæœ¬ä½¿ç”¨ï¼ˆä»Ž config.yaml è¯»å–æ‰€æœ‰å‚æ•°ï¼‰
python scripts/eval_emg.py

# æŒ‡å®šè¾“å…¥æ–‡ä»¶
python scripts/eval_emg.py \
    --baseline-file output/test_with_uncertainty.jsonl \
    --q0-file data/q0_test.jsonl \
    --alpha-lut-file output/alpha_u_lut.json

# æŒ‡å®šå›ºå®š Î± å€¼ï¼ˆé»˜è®¤ 0.5ï¼‰
python scripts/eval_emg.py --fixed-alpha 0.5

# æŒ‡å®šè¾“å‡ºç›®å½•
python scripts/eval_emg.py --output-dir output

# åŒæ—¶è¯„ä¼° hard é›†ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
python scripts/eval_emg.py --hard-file data/hard_eval_set.jsonl --hard-q0-file data/q0_hard.jsonl
```

---

## é…ç½®å‚æ•°ï¼ˆconfig.yamlï¼‰

```yaml
# è¯„ä¼°é…ç½®
evaluation:
  baseline_file: "output/test_with_uncertainty.jsonl"
  q0_file: "data/q0_test.jsonl"
  alpha_lut_file: "output/alpha_u_lut.json"
  fixed_alpha: 0.5  # å›ºå®šèžåˆçš„ Î± å€¼
  output_dir: "output"
  
  # å¯é€‰ï¼šå›°éš¾é›†è¯„ä¼°
  hard_file: "data/hard_eval_set.jsonl"  # å¯é€‰
  hard_q0_file: "data/q0_hard.jsonl"     # å¯é€‰
```

---

## å¢žé‡è¯„ä¼°è¯´æ˜Ž

- **baseline æˆ– qâ‚€ æ›´æ–°åŽ**ï¼š
  1. é‡æ–°ç”Ÿæˆ baseline é¢„æµ‹ç»“æžœï¼ˆ`uncertainty_analysis.py`ï¼‰
  2. é‡æ–°ç”Ÿæˆ qâ‚€ï¼ˆ`q0_builder.py`ï¼‰
  3. é‡æ–°è¿è¡Œ `emg_bucket_search.py` å’Œ `emg_fit_alpha_u.py`ï¼ˆå¦‚æžœéœ€è¦ï¼‰
  4. é‡æ–°è¿è¡Œ `eval_emg.py` å³å¯èŽ·å¾—æœ€æ–°è¯„ä¼°ç»“æžœ

- **ä»£ç æ— éœ€ä¿®æ”¹**ï¼š
  - æ‰€æœ‰è¾“å…¥éƒ½æ¥è‡ªæ–‡ä»¶ï¼Œåªè¦è¾“å…¥æ–‡ä»¶æ›´æ–°ï¼Œè¯„ä¼°ç»“æžœå°±ä¼šæ›´æ–°
  - è¯„ä¼°é€»è¾‘æœ¬èº«ä¸ä¾èµ–ç‰¹å®šçš„æ¨¡åž‹æˆ–æ•°æ®åˆ†å¸ƒ

---

## é¢„æœŸè¾“å‡ºç¤ºä¾‹

### æˆåŠŸæ ‡å‡†

**å¦‚æžœ EMG ä¼˜äºŽ baselineï¼Œé¢„æœŸçœ‹åˆ°ï¼š**
- âœ… EMG çš„ F1 > Baseline çš„ F1ï¼ˆæå‡ > 0.5%ï¼‰
- âœ… EMG çš„ NLL < Baseline çš„ NLLï¼ˆé™ä½Ž > 2%ï¼‰
- âœ… EMG çš„ ECE < Baseline çš„ ECEï¼ˆæ ¡å‡†æ›´å¥½ï¼‰
- âœ… åœ¨ hard é›†ä¸Šçš„æå‡æ›´æ˜Žæ˜¾ï¼ˆå› ä¸º hard é›†åŒ…å«æ›´å¤šé«˜ä¸ç¡®å®šæ€§æ ·æœ¬ï¼‰

### ç¤ºä¾‹è¾“å‡º

**console è¾“å‡ºï¼š**
```
============================================================
EMG æ•ˆæžœéªŒè¯
============================================================
åŠ è½½ baseline é¢„æµ‹ç»“æžœ: output/test_with_uncertainty.jsonl (4948 æ¡)
åŠ è½½ qâ‚€ åŽéªŒ: data/q0_test.jsonl (4948 æ¡)
åŠ è½½ Î±(u) æŸ¥è¡¨: output/alpha_u_lut.json (100 ä¸ªç‚¹)

è¯„ä¼° Baseline...
  - Accuracy: 85.95%
  - F1: 89.13%
  - NLL: 0.4523
  - ECE: 0.1234

è¯„ä¼°å›ºå®š Î±=0.5 èžåˆ...
  - Accuracy: 86.50%
  - F1: 89.56%
  - NLL: 0.4389
  - ECE: 0.1123

è¯„ä¼° EMGï¼ˆÎ±(u) è‡ªé€‚åº”ï¼‰...
  - Accuracy: 87.20%
  - F1: 90.23%
  - NLL: 0.4234
  - ECE: 0.0987

============================================================
å¯¹æ¯”åˆ†æž
============================================================
EMG vs Baseline:
  - F1 æå‡: +1.10% (90.23% vs 89.13%)
  - NLL é™ä½Ž: -6.39% (0.4234 vs 0.4523)
  - ECE é™ä½Ž: -20.02% (0.0987 vs 0.1234)

EMG vs å›ºå®š Î±=0.5:
  - F1 æå‡: +0.75% (90.23% vs 89.56%)
  - NLL é™ä½Ž: -3.53% (0.4234 vs 0.4389)
  - ECE é™ä½Ž: -12.11% (0.0987 vs 0.1123)

âœ“ EMG åœ¨æ‰€æœ‰æŒ‡æ ‡ä¸Šä¼˜äºŽ baseline å’Œå›ºå®š Î± èžåˆï¼
```

---

## ä¸Ž Day3 å’Œ Day7 çš„å¯¹æ¯”

| ç‰¹æ€§ | Day3ï¼ˆBaseline è¯„ä¼°ï¼‰ | Day7ï¼ˆÎ± æœç´¢ï¼‰ | Day9ï¼ˆEMG éªŒè¯ï¼‰ |
|------|---------------------|---------------|-----------------|
| **ç›®æ ‡** | è¯„ä¼° baseline æ¨¡åž‹æ€§èƒ½ | æ‰¾åˆ°æœ€ä¼˜ Î±* | éªŒè¯ EMG æ•ˆæžœ |
| **è¾“å…¥** | baseline æ¨¡åž‹ + test é›† | dev é›† + qâ‚€ + u åˆ†æ¡¶ | baseline é¢„æµ‹ + qâ‚€ + Î±(u) |
| **è¾“å‡º** | baseline æŒ‡æ ‡ | bucket_alpha_star.csv | ä¸‰ç§æ–¹æ³•å¯¹æ¯”æŒ‡æ ‡ |
| **ç”¨é€”** | å»ºç«‹åŸºçº¿æ€§èƒ½ | è®­ç»ƒ Î±(u) å‡½æ•° | éªŒè¯ EMG ä¼˜åŠ¿ |
| **å…³ç³»** | æä¾› baseline æ€§èƒ½åŸºå‡† | ä¸º Day9 æä¾› Î±(u) | æœ€ç»ˆéªŒè¯ EMG æ–¹æ³• |

---

**æœ€åŽæ›´æ–°**ï¼š2025-12-14  
**çŠ¶æ€**ï¼šðŸ“ å¾…å®žçŽ°

**æŠ€æœ¯é€‰åž‹**ï¼šæŽ¨èæ–¹æ¡ˆ 1ï¼ˆç®€å•æ–¹æ¡ˆï¼‰ï¼Œå¿«é€ŸéªŒè¯ EMG æ•ˆæžœ

