# 实验分析

**最后更新**：2025-12-14

---

## 🔍 EMG 无提升原因分析

### 核心问题

**Day9 初始结果**（q₀参数调整前）：
| 方法 | F1 | NLL | ECE | 对比Baseline |
|------|----|-----|-----|-------------|
| Baseline | 89.13% | 0.4001 | 0.0730 | - |
| EMG | 88.36% | 0.4229 | 0.1021 | ❌ 全部下降 |

### 根本原因

#### 1. q₀ 质量问题（主要原因）

**现象**：
- q₀ 平均敏感概率 0.82 过高
- 与实际标签分布（64.8%敏感）不匹配

**问题分析**：
- 词表匹配率过高，可能引入大量误报
- q₀ 的 Precision 可能很低（<0.70）
- 即使只有 25% 权重（α=0.75），也会显著影响性能
- 当 α=0.00（完全依赖 q₀）时，噪声被放大

#### 2. Baseline 性能已经很高

- F1: 89.13% 已经很高
- 79% 样本在低不确定性区间，baseline 已经很准确
- 改善空间有限

#### 3. 门控模型过于简单

- 只考虑不确定性 u，忽略 p 和 q₀ 的置信度差异
- 线性融合可能不够灵活

---

## 📊 高不确定性切片详细分析

### 切片评估结果

**全局对比**：
| 方法 | F1 | NLL | ECE |
|------|----|-----|-----|
| Baseline | 89.13% | 0.4001 | 0.0730 |
| EMG | 88.13% | 0.3892 | 0.0648 |

### 低不确定性切片（u < 0.1，79%样本）

| 方法 | F1 | NLL | ECE |
|------|----|-----|-----|
| Baseline | 94.21% | 0.3193 | 0.0635 |
| EMG | 94.21% | 0.2815 | 0.0684 |

**结论**：✅ 完美保持性能，NLL 显著改善 11.8%

### 中等不确定性切片（0.1 ≤ u < 0.3，13%样本）

| 方法 | F1 | NLL | ECE |
|------|----|-----|-----|
| Baseline | 67.95% | 0.7143 | 0.1436 |
| EMG | 58.54% | 0.7188 | 0.1369 |

**结论**：❌ F1 显著下降 9.41%，q₀ 噪声影响显著

### 高不确定性切片（u ≥ 0.3，8%样本）

| 方法 | F1 | NLL | ECE |
|------|----|-----|-----|
| Baseline | 63.41% | 1.1428 | 0.1924 |
| EMG | 64.22% | 1.5382 | 1.0206 |

**结论**：
- ✅ F1 略升 +1.14%
- ❌ NLL 增加 34.6%
- ❌ ECE 增加 430.89%

**根本原因**：
- α=0.00（完全依赖 q₀）
- q₀ 在高 u 样本上质量差
- 完全信任的风险导致概率质量严重恶化

---

## 🔧 q₀ 改进措施

### 实施的改进

1. **降低 max_sensitive_prob**：0.95 → 0.75
2. **提高 min_matches_for_sensitive**：1 → 2
3. **降低类别权重**：politics_weight 0.8→0.6, abuse_weight 0.6→0.5
4. **降低缩放因子**：tanh 缩放因子 10 → 5

### 改进效果

- ✅ **NLL**: 从增加 5.70% → 降低 2.72%（改善 8.42 个百分点）
- ✅ **ECE**: 从增加 39.84% → 降低 11.16%（改善 51 个百分点）
- ⚠️ **F1**: 从下降 0.86% → 下降 1.11%（略有恶化）

---

## 📋 开题报告 vs 实际结果

### 预期目标

1. **降低高置信错误**：解决"误判但高置信"的问题
2. **提高可靠性**：在高不确定性切片中展现 ECE 下降、F1 提升
3. **风险控制**：融合引入的期望风险不升高
4. **全局改进**：满足风险控制与校准改进目标

### 实际结果对比

| 预期目标 | 实际结果 | 符合度 |
|---------|---------|--------|
| ✅ F1 提升 | ❌ F1 下降 1.11% | **不符合** |
| ✅ ECE 下降 | ✅ ECE 降低 11.16% | **符合** ✅ |
| ✅ NLL 降低 | ✅ NLL 降低 2.72% | **符合** ✅ |
| ✅ 概率质量改善 | ✅ NLL/ECE 显著改善 | **符合** ✅ |
| ⚠️ 高u切片改进 | ❌ 高u切片NLL/ECE恶化 | **部分符合** ⚠️ |

### 结论

**部分达成目标**：
- ✅ 概率质量改善（NLL/ECE）符合预期
- ✅ 风险控制目标达成
- ❌ 高不确定性切片存在问题（已有改进方案）

---

## 🎯 理论 vs 实际分析

### EMG 理论预期

1. **不确定性预测准确**：u 与错误率强相关 → ✅ 已验证（相关系数 0.8379）
2. **α(u) 单调递减**：低 u 时 α 大，高 u 时 α 小 → ✅ 已验证
3. **EMG 改善性能**：理论上在 q₀ 质量好时应该改善 → ⚠️ 部分达成（概率质量改善，但F1略降）

### 理论条件 vs 实际条件

| 理论条件 | 实际条件 | 差距 |
|---------|---------|------|
| q₀ 质量好（Precision高） | q₀ 质量一般（可能Precision<0.70） | ❌ 差距大 |
| Baseline 有改进空间 | Baseline 性能已很高（F1: 89.13%） | ⚠️ 改善空间小 |
| 测试集分布与训练集一致 | 可能存在分布差异 | ⚠️ 待验证 |

### 结论

**EMG 机制本身是正确的**，但需要：
1. 提高 q₀ 质量（已实施参数调整，效果明显）
2. 改进门控机制（一致性门控、知识阈值门控，P1）

---

## 💡 改进建议（按优先级）

### P1：高性价比改进（推荐立即实施）

1. **一致性门控**（1-2小时）
   - 仅当 `argmax(p) == argmax(q₀)` 时允许 α(u) 生效
   - 否则强制 α=0 或小 α，减少 q₀ 带偏导致的 F1 损失

2. **知识阈值门控**（1小时）
   - 当 `max(q₀) < 0.6` 时直接把 α=1.0（完全信任模型）
   - 避免使用弱知识，减少噪声

### P2：可选优化

3. **进一步优化 q₀ 质量**
   - 词表清洗和审核
   - 验证 q₀ 的 Precision/Recall
   - 尝试更精细的概率计算策略

4. **重新评估高 u 切片的 α***
   - 可能不应该完全依赖 q₀（α=0.00）
   - 尝试更保守的 α 值（如最小 α=0.2）

---

## 📝 关键发现总结

1. **EMG 在低 u 切片表现优秀**：完美保持性能，改善概率质量
2. **EMG 在高 u 切片存在严重问题**：虽然 F1 略升，但概率质量大幅恶化
3. **根本原因**：q₀ 在高 u 样本上质量差，当 α=0.00 时完全依赖导致问题放大
4. **解决方案**：需要实施一致性门控或知识阈值门控，避免完全信任低质量 q₀
5. **改进效果显著**：参数调整后，NLL/ECE 从恶化转为改善，证明方向正确

